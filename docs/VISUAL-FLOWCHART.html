<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandanten-Portal - Interactive Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .flowchart-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        .description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-tab {
            padding: 10px 20px;
            background: #9f1a1d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .nav-tab:hover {
            background: #7a1417;
        }
        .nav-tab.active {
            background: #5a0e10;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Mandanten-Portal System Flowchart</h1>
        <p style="text-align: center; color: #666;">Interactive visualization of the insolvency management system</p>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('main')">Main Flow</button>
            <button class="nav-tab" onclick="showSection('document')">Document Processing</button>
            <button class="nav-tab" onclick="showSection('status')">Status Workflow</button>
            <button class="nav-tab" onclick="showSection('architecture')">Architecture</button>
            <button class="nav-tab" onclick="showSection('admin')">Admin Actions</button>
        </div>

        <!-- Main Flow Section -->
        <div id="main" class="section active">
            <div class="flowchart-section">
                <h2>üìã Main System Flow</h2>
                <p class="description">
                    This flowchart shows the complete lifecycle of a client case from creation to completion,
                    including document upload, payment processing, and creditor management.
                </p>
                <div class="mermaid">
                    graph TB
                        Start([Client Insolvency Case]) --> Create[Agent Creates Client]
                        Create --> Portal[Generate Portal Access]
                        Portal --> Email[Send Login Email]
                        
                        Email --> Login{Client Logs In?}
                        Login -->|No| Reminder1[Send Reminder]
                        Reminder1 --> Login
                        Login -->|Yes| Upload[Upload Documents]
                        
                        Upload --> AI[AI Processing<br/>3s per document]
                        AI --> Extract[Extract Creditors]
                        
                        Extract --> Payment{Payment Made?}
                        Payment -->|No| WaitPay[Wait for Payment]
                        Payment -->|Yes| Delay[Schedule 24h Delay]
                        
                        WaitPay --> PayConfirm[Payment Confirmed]
                        PayConfirm --> Delay
                        
                        Delay --> Check24{24 Hours?}
                        Check24 -->|No| Override{Admin Override?}
                        Override -->|Yes| Zendesk[Create Zendesk Ticket]
                        Override -->|No| Check24
                        Check24 -->|Yes| Zendesk
                        
                        Zendesk --> Review{Review Type?}
                        Review -->|Auto| ClientConf[Client Confirmation]
                        Review -->|Manual| Agent[Agent Review]
                        Review -->|No Creditors| Manual[Manual Check]
                        
                        Agent --> Approve[Approve Creditors]
                        Manual --> Approve
                        Approve --> ClientConf
                        
                        ClientConf --> Confirm{Confirmed?}
                        Confirm -->|Yes| Contact[Contact Creditors]
                        Confirm -->|No| Follow[Follow Up]
                        Follow --> ClientConf
                        
                        Contact --> Track[Track Responses]
                        Track --> Plan[Settlement Plan]
                        Plan --> Complete([Complete])
                        
                        style Start fill:#e1f5e1
                        style Complete fill:#e1f5e1
                        style AI fill:#fff3cd
                        style Zendesk fill:#cfe2ff
                        style Override fill:#f8d7da
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #e1f5e1;"></div>
                        <span>Start/End</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #fff3cd;"></div>
                        <span>AI Processing</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #cfe2ff;"></div>
                        <span>Zendesk Integration</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #f8d7da;"></div>
                        <span>Admin Action</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Processing Section -->
        <div id="document" class="section">
            <div class="flowchart-section">
                <h2>üìÑ Document Processing Flow</h2>
                <p class="description">
                    Detailed view of how documents are processed using AI to extract creditor information
                    with confidence scoring and validation.
                </p>
                <div class="mermaid">
                    graph LR
                        Upload([Document Upload]) --> Validate{Valid File?}
                        Validate -->|Invalid| Error[Show Error]
                        Validate -->|Valid| Store[Store in /uploads]
                        
                        Store --> Queue[Processing Queue]
                        Queue --> Delay[3 Second Delay]
                        Delay --> AI[AI Analysis]
                        
                        AI --> Type{Document Type?}
                        Type -->|Creditor| Extract[Extract Data]
                        Type -->|Other| NonCred[Mark Non-Creditor]
                        
                        Extract --> Parse[Parse:<br/>- Name<br/>- Amount<br/>- Address<br/>- Reference]
                        Parse --> Conf{Confidence Score}
                        
                        Conf -->|>80%| Auto[Auto Approve]
                        Conf -->|<80%| Review[Flag for Review]
                        
                        Auto --> Save[(Save to DB)]
                        Review --> Save
                        NonCred --> Save
                        
                        Save --> AllDone{All Docs Done?}
                        AllDone -->|No| Next[Next Document]
                        AllDone -->|Yes| Webhook[Schedule Webhook]
                        
                        Next --> Queue
                        
                        style AI fill:#fff3cd
                        style Auto fill:#d1e7dd
                        style Review fill:#f8d7da
                </div>
            </div>
        </div>

        <!-- Status Workflow Section -->
        <div id="status" class="section">
            <div class="flowchart-section">
                <h2>üîÑ Status Workflow</h2>
                <p class="description">
                    The complete status progression showing how cases move through the system
                    from creation to completion.
                </p>
                <div class="mermaid">
                    stateDiagram-v2
                        [*] --> Created: New Client
                        Created --> PortalSent: Send Access
                        PortalSent --> DocsUploaded: Upload Documents
                        DocsUploaded --> Processing: AI Processing
                        Processing --> WaitPayment: Complete
                        WaitPayment --> Confirmed: Payment Made
                        Confirmed --> Review: 24h or Override
                        Review --> AwaitClient: Approved
                        AwaitClient --> Active: Client Confirms
                        Active --> Completed: All Done
                        Completed --> [*]
                        
                        Created --> Cancelled: No Response
                        PortalSent --> Cancelled: Inactive
                        WaitPayment --> Cancelled: No Payment
                        Cancelled --> [*]
                </div>
            </div>
        </div>

        <!-- Architecture Section -->
        <div id="architecture" class="section">
            <div class="flowchart-section">
                <h2>üèóÔ∏è System Architecture</h2>
                <p class="description">
                    High-level view of the system components and their interactions.
                </p>
                <div class="mermaid">
                    graph TB
                        subgraph "Frontend"
                            Client[Client Portal]
                            Admin[Admin Portal]
                            Agent[Agent Portal]
                        end
                        
                        subgraph "Backend"
                            API[Express API]
                            Services[Services Layer]
                            Tasks[Scheduled Tasks]
                        end
                        
                        subgraph "Data"
                            Mongo[(MongoDB)]
                            Files[File Storage]
                        end
                        
                        subgraph "External"
                            Zendesk[Zendesk API]
                            AI[Claude/OpenAI]
                            Email[Email Service]
                        end
                        
                        Client --> API
                        Admin --> API
                        Agent --> API
                        
                        API --> Services
                        API --> Tasks
                        
                        Services --> Mongo
                        Services --> Files
                        Tasks --> Mongo
                        
                        Services --> Zendesk
                        Services --> AI
                        Services --> Email
                        
                        style Client fill:#e3f2fd
                        style Admin fill:#fce4ec
                        style Agent fill:#e8f5e9
                </div>
            </div>
        </div>

        <!-- Admin Actions Section -->
        <div id="admin" class="section">
            <div class="flowchart-section">
                <h2>üë®‚Äçüíº Admin Actions Flow</h2>
                <p class="description">
                    Administrative functions including the immediate review button and user management.
                </p>
                <div class="mermaid">
                    graph LR
                        Admin([Admin Login]) --> Dash[Dashboard]
                        
                        Dash --> Actions{Select Action}
                        
                        Actions -->|Analytics| Stats[View Statistics]
                        Actions -->|Users| List[User List]
                        Actions -->|Settings| Config[System Config]
                        
                        List --> User[Select User]
                        User --> Details[View Details]
                        User --> Immediate{Immediate Review?}
                        
                        Immediate -->|Check| Valid{Valid State?}
                        Valid -->|Yes| Trigger[üî• Trigger Now]
                        Valid -->|No| Error[Show Error]
                        
                        Trigger --> Cancel[Cancel 24h Delay]
                        Cancel --> Create[Create Zendesk Ticket]
                        Create --> Update[Update Status]
                        Update --> Success[‚úÖ Success]
                        
                        style Trigger fill:#f8d7da
                        style Success fill:#d1e7dd
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#fff',
                primaryTextColor: '#333',
                primaryBorderColor: '#9f1a1d',
                lineColor: '#333',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#fff'
            }
        });

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Mark the clicked tab as active
            event.target.classList.add('active');
            
            // Re-render Mermaid diagrams
            mermaid.init();
        }
    </script>
</body>
</html>