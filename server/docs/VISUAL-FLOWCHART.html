<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandanten-Portal - Interactive Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .flowchart-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        .description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-tab {
            padding: 10px 20px;
            background: #9f1a1d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .nav-tab:hover {
            background: #7a1417;
        }
        .nav-tab.active {
            background: #5a0e10;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏢 Mandanten-Portal System Flowchart</h1>
        <p style="text-align: center; color: #666;">Interactive visualization of the insolvency management system</p>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('main')">Main Flow</button>
            <button class="nav-tab" onclick="showSection('document')">Document Processing</button>
            <button class="nav-tab" onclick="showSection('settlement')">Settlement Calculation</button>
            <button class="nav-tab" onclick="showSection('status')">Status Workflow</button>
            <button class="nav-tab" onclick="showSection('architecture')">Architecture</button>
            <button class="nav-tab" onclick="showSection('admin')">Admin Actions</button>
            <button class="nav-tab" onclick="showSection('calculations')">Document Calculations</button>
        </div>

        <!-- Main Flow Section -->
        <div id="main" class="section active">
            <div class="flowchart-section">
                <h2>📋 Main System Flow</h2>
                <p class="description">
                    This flowchart shows the complete lifecycle of a client case from creation to completion,
                    including document upload, payment processing, and creditor management.
                </p>
                <div class="mermaid">
                    graph TB
                        Start([Client Insolvency Case]) --> Create[Agent Creates Client]
                        Create --> Portal[Generate Portal Access]
                        Portal --> SendLoginEmail[Send Login Email]
                        
                        SendLoginEmail --> LoginCheck{Client Logs In?}
                        LoginCheck -->|No - 7 Days| LoginReminder{Login Reminder Sent?}
                        LoginReminder -->|No| SendLoginReminder[📧 Send Login Reminder]
                        LoginReminder -->|Yes| WaitLogin[Continue Waiting]
                        SendLoginReminder --> WaitLogin
                        WaitLogin --> LoginCheck
                        
                        LoginCheck -->|Yes| UploadCheck{Uploads Documents?}
                        UploadCheck -->|No| LoginTimer[Start 7-Day Timer]
                        LoginTimer --> DocReminderCheck{7 Days Since Login?}
                        DocReminderCheck -->|No| WaitForUpload[Wait for Upload]
                        WaitForUpload --> UploadCheck
                        DocReminderCheck -->|Yes| DocReminderSent{Doc Reminder Sent?}
                        DocReminderSent -->|No| SendDocReminder[📧 Send Document Upload Reminder]
                        DocReminderSent -->|Yes| WaitForUpload
                        SendDocReminder --> WaitForUpload
                        
                        UploadCheck -->|Yes| AIProcess[🔍 Google OCR + AI Processing<br/>3s per document]
                        AIProcess --> TextDetected{Text Detected?}
                        TextDetected -->|No| NoTextLabel[📄 Label: 'No Text'<br/>End Processing]
                        TextDetected -->|Yes| ExtractCreditors[🤖 AI Extract Creditors]
                        
                        ExtractCreditors --> ConfidenceCheck{AI Confidence?}
                        ConfidenceCheck -->|≥ 80%| AIAnalyzedLabel[✅ Label: 'AI Analyzed']
                        ConfidenceCheck -->|< 80%| ManualReviewLabel[⚠️ Label: 'Manual Review']
                        
                        AIAnalyzedLabel --> AllDocsLabeled{All Docs Labeled?}
                        ManualReviewLabel --> AllDocsLabeled
                        NoTextLabel --> AllDocsLabeled
                        
                        AllDocsLabeled -->|No| NextDoc[Process Next Document]
                        NextDoc --> AIProcess
                        AllDocsLabeled -->|Yes| PaymentCheck{First Payment Made?}
                        PaymentCheck -->|No Payment Yet| WaitPayment[Wait for Payment<br/>No Agent Review Yet]
                        PaymentCheck -->|Payment Made + Has Docs| ReviewNeeded{Any Manual Review<br/>Documents?}
                        PaymentCheck -->|Payment Made + No Docs| StartPaymentReminders[📧 Start Document<br/>Upload Reminders<br/>Every 2 Days]
                        
                        WaitPayment --> PaymentConfirm[Payment Confirmed]
                        PaymentConfirm --> BackToReviewCheck[Check if Documents<br/>Need Review]
                        BackToReviewCheck --> ReviewNeeded
                        
                        ReviewNeeded -->|Yes| AgentReview[👨‍💼 Agent Reviews ONLY<br/>Manual Review Documents<br/>Ignores No Text docs]
                        ReviewNeeded -->|No All AI Analyzed| ScheduleDelay[Schedule 24h Delay]
                        AgentReview --> ScheduleDelay
                        StartPaymentReminders --> PaymentReminderLoop{Reminder Due?}
                        PaymentReminderLoop -->|Yes, 2+ days| PaymentReminderSent{Last Reminder Sent?}
                        PaymentReminderSent -->|>2 days ago| SendPaymentReminder[📧 Send Escalating<br/>Document Reminder]
                        PaymentReminderSent -->|<2 days ago| WaitPaymentReminder[Wait 2 Days]
                        PaymentReminderLoop -->|No| WaitPaymentReminder
                        SendPaymentReminder --> WaitPaymentReminder
                        WaitPaymentReminder --> CheckUpload{Documents Uploaded?}
                        CheckUpload -->|No| PaymentReminderLoop
                        CheckUpload -->|Yes| BackToAI[Back to AI Processing]
                        BackToAI --> AIProcess
                        ScheduleDelay --> DelayCheck{24 Hours Passed?}
                        DelayCheck -->|No| DelayCheck
                        DelayCheck -->|Yes| CreateTicket[Create Zendesk Ticket]
                        
                        CreateTicket --> ReviewType{Review Type?}
                        ReviewType -->|Auto Approved| ClientConfirmation[Client Confirmation]
                        ReviewType -->|Manual Review| AgentReview[Agent Review]
                        ReviewType -->|No Creditors| ManualCheck[Manual Check]
                        
                        AgentReview --> ApproveCreditors[Approve Creditors]
                        ManualCheck --> ApproveCreditors
                        ApproveCreditors --> ClientConfirmation
                        
                        ClientConfirmation --> ClientConfirmed{Client Confirmed?}
                        ClientConfirmed -->|Yes| ContactCreditors[📧 Contact ALL Creditors<br/>Email Template: Debt Verification Request<br/>Purpose: Verify current debt amounts<br/>for settlement calculation]
                        ClientConfirmed -->|No| FollowUpClient[Follow Up]
                        FollowUpClient --> ClientConfirmation
                        
                        ContactCreditors --> Start30DayTimer[⏰ Start 30-Day Response Timer]
                        Start30DayTimer --> TrackResponses[📋 Track Creditor Responses<br/>• Response Date<br/>• Updated Debt Amount<br/>• Contact Status<br/>• Response Email Content]
                        
                        TrackResponses --> Check30Days{30 Days<br/>Passed?}
                        Check30Days -->|No| TrackResponses
                        Check30Days -->|Yes| AnalyzeResponses[🔍 Analyze Response Results<br/>Who Responded vs No Response]
                        
                        AnalyzeResponses --> CreateAmountTable[📊 Create Final Amount Table<br/>• Responded: Use New Amount<br/>• No Response: Use Original Amount<br/>• No Original Amount: Default €100]
                        
                        CreateAmountTable --> CalculateSettlement[🧮 Calculate Settlement Plan<br/>German Garnishment Logic]
                        CalculateSettlement --> GenerateDocuments[📄 Generate Two Documents<br/>1. Schuldenbereinigungsplan<br/>2. Forderungsübersicht]
                        GenerateDocuments --> Complete([Complete])
                        
                        style Start fill:#e1f5e1
                        style Complete fill:#e1f5e1
                        style AIProcess fill:#fff3cd
                        style CreateTicket fill:#cfe2ff
                        style SendLoginReminder fill:#ffe4e1
                        style SendDocReminder fill:#ffe4e1
                        style SendPaymentReminder fill:#ffe4e1
                        style StartPaymentReminders fill:#fff2cc
                        style AIAnalyzedLabel fill:#d1e7dd
                        style ManualReviewLabel fill:#f8d7da
                        style NoTextLabel fill:#ffecb3
                        style ContactCreditors fill:#e8f5e9
                        style TrackResponses fill:#fff3e0
                        style AnalyzeResponses fill:#f3e5f5
                        style CreateAmountTable fill:#e0f2f1
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #e1f5e1;"></div>
                        <span>Start/End</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #fff3cd;"></div>
                        <span>AI Processing</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #cfe2ff;"></div>
                        <span>Zendesk Integration</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ffe4e1;"></div>
                        <span>Email Reminders</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #fff2cc;"></div>
                        <span>Reminder System</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Processing Section -->
        <div id="document" class="section">
            <div class="flowchart-section">
                <h2>📄 Enhanced Document Processing Flow</h2>
                <p class="description">
                    Detailed view of how documents are processed using Google OCR and AI analysis
                    with confidence scoring, text detection, and the 80% threshold rule.
                </p>
                <div class="mermaid">
                    graph TB
                        Upload([Document Upload]) --> Validate{Valid File Type?}
                        Validate -->|Invalid| ShowError[❌ Show File Type Error]
                        Validate -->|Valid| Store[💾 Store in /uploads]
                        
                        Store --> Queue[📋 Add to Processing Queue]
                        Queue --> Delay[⏱️ 3 Second Delay per Document]
                        Delay --> OCR[🔍 Google OCR Processing]
                        
                        OCR --> TextCheck{Text Detected?}
                        TextCheck -->|No Text| NoTextEnd[📄 Mark as 'No Text'<br/>End Processing]
                        TextCheck -->|Text Found| AIAnalysis[🤖 AI Analysis<br/>Claude/OpenAI]
                        
                        AIAnalysis --> DocumentType{Document Classification}
                        DocumentType -->|Creditor Document| ExtractData[📊 Extract Creditor Data:<br/>• Company Name<br/>• Amount Owed<br/>• Address<br/>• Reference Number]
                        DocumentType -->|Non-Creditor| MarkNonCreditor[📝 Label: Non-Creditor]
                        
                        ExtractData --> ConfidenceCheck{Confidence Score?}
                        ConfidenceCheck -->|≥ 80%| LabelAIAnalyzed[✅ Label: 'AI Analyzed'<br/>High Confidence]
                        ConfidenceCheck -->|< 80%| LabelManualReview[⚠️ Label: 'Manual Review'<br/>Low Confidence]
                        
                        LabelAIAnalyzed --> SaveToDB[(💾 Save to MongoDB)]
                        LabelManualReview --> SaveToDB
                        MarkNonCreditor --> SaveToDB
                        NoTextEnd --> SaveToDB
                        
                        SaveToDB --> CheckAllDocs{All Documents<br/>Labeled?}
                        CheckAllDocs -->|No| NextDocument[➡️ Process Next Document]
                        CheckAllDocs -->|Yes| PaymentStatusCheck{First Payment<br/>Made?}
                        
                        PaymentStatusCheck -->|No| WaitForPayment[⏳ Wait for Payment<br/>No Agent Review Triggered]
                        PaymentStatusCheck -->|Yes| CheckReviewNeeded{Any 'Manual Review'<br/>Documents?}
                        
                        CheckReviewNeeded -->|Yes| AgentMustReview[👨‍💼 Agent Must Review<br/>ALL Manual Review Documents]
                        CheckReviewNeeded -->|No| AllAIProcessed[All Documents<br/>AI Analyzed]
                        
                        AgentMustReview --> TriggerWebhook[🔔 Trigger Processing<br/>Complete Webhook]
                        AllAIProcessed --> TriggerWebhook
                        
                        NextDocument --> Queue
                        
                        style OCR fill:#e3f2fd
                        style AIAnalysis fill:#fff3cd
                        style LabelAIAnalyzed fill:#d1e7dd
                        style LabelManualReview fill:#f8d7da
                        style NoTextEnd fill:#ffecb3
                        style ConfidenceCheck fill:#e8f5e8
                        style AgentMustReview fill:#fff2cc
                        style PaymentStatusCheck fill:#e1f5fe
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #e3f2fd;"></div>
                        <span>Google OCR</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #fff3cd;"></div>
                        <span>AI Processing</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #d1e7dd;"></div>
                        <span>AI Analyzed (≥80%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #f8d7da;"></div>
                        <span>Manual Review (<80%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ffecb3;"></div>
                        <span>No Text - End Processing</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #e1f5fe;"></div>
                        <span>Payment Check</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #fff2cc;"></div>
                        <span>Agent Review Required</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h4 style="margin: 0 0 10px 0; color: #1976D2;">📊 AI Processing & Payment Logic:</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>Step 1 - AI Processing:</strong> Documents get labeled based on confidence</li>
                        <li><strong>≥ 80% Confidence:</strong> Label = 'AI Analyzed' (ready for processing)</li>
                        <li><strong>< 80% Confidence:</strong> Label = 'Manual Review' (needs agent review)</li>
                        <li><strong>No Text Detected:</strong> Label = 'No Text' → END (no further processing)</li>
                        <li><strong>Step 2 - Payment Check:</strong> Only after payment is agent review triggered</li>
                        <li><strong>Agent Review:</strong> Reviews ONLY 'Manual Review' documents (ignores 'No Text' docs)</li>
                        <li><strong>Example:</strong> 20 docs = 18 AI analyzed + 1 manual review + 1 no text → Agent reviews only 1 doc</li>
                    </ul>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 15px 0; color: #155724;">📧 Enhanced Creditor Contact Workflow</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin: 10px 0;">1. 📤 Contact Creditors Phase:</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                            <li><strong>Email Template:</strong> "Debt Verification Request for Settlement Negotiation"</li>
                            <li><strong>Purpose:</strong> Request current debt amounts to calculate accurate settlement plan</li>
                            <li><strong>Reason:</strong> Original document amounts may be outdated, need current balance for fair distribution</li>
                            <li><strong>Content:</strong> Legal notice requesting current debt balance, interest, and fees within 30 days</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin: 10px 0;">2. 📊 Response Tracking System:</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                            <li><strong>Tracked Data:</strong> Response date, updated amount, email content, contact status</li>
                            <li><strong>Status Types:</strong> "responded", "no_response", "email_failed"</li>
                            <li><strong>30-Day Timer:</strong> Automatic analysis trigger after response period ends</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin: 10px 0;">3. 🔍 30-Day Analysis Logic:</h5>
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #e9ecef;">
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Scenario</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Amount Logic</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>Creditor Responded</strong></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Use new amount from response</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Original: €500 → Response: €650 → Use: €650</td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>No Response + Had Original</strong></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Use original document amount</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Original: €300 → No response → Use: €300</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>No Response + No Original</strong></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Default fallback amount</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Original: N/A → No response → Use: €100</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h5 style="color: #495057; margin: 10px 0;">4. 📈 Settlement Plan Generation:</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                            <li><strong>Final Table:</strong> All creditors with finalized amounts using 3-tier logic above</li>
                            <li><strong>Percentage Calculation:</strong> Each creditor's share based on total debt amount</li>
                            <li><strong>Monthly Quotas:</strong> Distribution of available funds based on garnishment calculation</li>
                            <li><strong>Settlement Document:</strong> Legal document sent to client for approval</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settlement Calculation Section -->
        <div id="settlement" class="section">
            <div class="flowchart-section">
                <h2>🧮 Settlement Plan Calculation Flow</h2>
                <p class="description">
                    Detailed view of how the German garnishment calculator creates settlement plans using official 2025-2026 garnishment tables.
                </p>
                <div class="mermaid">
                    graph TB
                        StartCalc([Settlement Calculation]) --> InputFinancial[💰 Input Financial Data<br/>• Net Income<br/>• Marital Status<br/>• Number of Children]
                        
                        InputFinancial --> GarnishmentLookup[📊 German Garnishment Table Lookup<br/>Official 2025-2026 Pfändungstabelle<br/>334 income brackets]
                        
                        GarnishmentLookup --> DependentCalc{Calculate Dependents}
                        DependentCalc --> MarriedCheck{Married?}
                        MarriedCheck -->|Yes| AddSpouse[Add +1 Dependent<br/>for Spouse]
                        MarriedCheck -->|No| ChildrenCount[Count Children Only]
                        AddSpouse --> TotalDependents[Total Dependents<br/>= Children + Spouse]
                        ChildrenCount --> TotalDependents
                        
                        TotalDependents --> TableLookup[🔍 Find Garnishable Amount<br/>Based on Income + Dependents]
                        TableLookup --> GarnishableAmount[💶 Monthly Garnishable Amount<br/>Example: €209.49/month]
                        
                        GarnishableAmount --> GetCreditors[📋 Get Final Creditor List<br/>with 3-Tier Amounts]
                        GetCreditors --> CalculateTotal[➕ Calculate Total Debt<br/>Sum all creditor amounts]
                        
                        CalculateTotal --> DistributionLoop[🔄 For Each Creditor:<br/>Calculate Proportional Share]
                        DistributionLoop --> PercentageCalc[📊 Debt Percentage<br/>= Creditor Amount / Total Debt]
                        PercentageCalc --> MonthlyQuota[💰 Monthly Payment<br/>= Garnishable × Percentage]
                        MonthlyQuota --> Plan36Months[📅 36-Month Plan<br/>Total = Monthly × 36]
                        
                        Plan36Months --> NextCreditor{More Creditors?}
                        NextCreditor -->|Yes| DistributionLoop
                        NextCreditor -->|No| FinalCalculation[✅ Settlement Plan Complete]
                        
                        FinalCalculation --> DocGeneration[📄 Generate Documents]
                        DocGeneration --> SchuldenPlan[📋 Schuldenbereinigungsplan<br/>• Monthly payment breakdown<br/>• 36-month schedule<br/>• Creditor quotas<br/>• Legal formatting]
                        DocGeneration --> ForderungsUeber[📑 Forderungsübersicht<br/>• Complete creditor list<br/>• Contact information<br/>• Amount sources<br/>• Response status]
                        
                        SchuldenPlan --> DocumentsReady[📤 Documents Ready<br/>for Download]
                        ForderungsUeber --> DocumentsReady
                        
                        style GarnishmentLookup fill:#e3f2fd
                        style GarnishableAmount fill:#c8e6c9
                        style PercentageCalc fill:#fff3cd
                        style SchuldenPlan fill:#f3e5f5
                        style ForderungsUeber fill:#e8f5e9
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h4 style="margin: 0 0 15px 0; color: #004085;">🧮 Settlement Calculation Details</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin: 10px 0;">1. 📊 German Garnishment Table (2025-2026)</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                            <li><strong>334 Income Brackets</strong>: From €1,559.99 to €4,766.99 net income</li>
                            <li><strong>Dependent Levels</strong>: 0-5+ dependents (married = +1 dependent)</li>
                            <li><strong>Official Source</strong>: German legal garnishment rates (Pfändungstabelle)</li>
                            <li><strong>Example</strong>: €3,000 net, married, 1 child (2 dependents) = €209.49 garnishable</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin: 10px 0;">2. 🎯 Proportional Distribution Formula</h5>
                        <div style="background: #e9ecef; padding: 15px; border-radius: 6px; font-family: monospace;">
                            <strong>For each creditor:</strong><br/>
                            • Debt Percentage = Creditor Amount ÷ Total Debt<br/>
                            • Monthly Payment = Garnishable Income × Debt Percentage<br/>
                            • 36-Month Total = Monthly Payment × 36<br/><br/>
                            
                            <strong>Example with €25,000 total debt:</strong><br/>
                            • Creditor A: €5,000 debt = 20% = €41.90/month = €1,508.40 total<br/>
                            • Creditor B: €3,000 debt = 12% = €25.14/month = €905.04 total<br/>
                            • Creditor C: €17,000 debt = 68% = €142.45/month = €5,128.20 total
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #495057; margin: 10px 0;">3. 📋 The Two Generated Documents</h5>
                        
                        <div style="display: flex; gap: 20px; margin-top: 10px;">
                            <div style="flex: 1; background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                                <h6 style="color: #6f42c1; margin: 0 0 10px 0;">📋 Schuldenbereinigungsplan</h6>
                                <ul style="margin: 0; padding-left: 15px; font-size: 13px;">
                                    <li>Monthly payment breakdown per creditor</li>
                                    <li>36-month payment schedule</li>
                                    <li>Total garnishable income calculation</li>
                                    <li>Percentage distribution table</li>
                                    <li>Legal formatting for court submission</li>
                                    <li>Client and financial data summary</li>
                                </ul>
                            </div>
                            
                            <div style="flex: 1; background: white; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                                <h6 style="color: #28a745; margin: 0 0 10px 0;">📑 Forderungsübersicht</h6>
                                <ul style="margin: 0; padding-left: 15px; font-size: 13px;">
                                    <li>Complete list of all creditors</li>
                                    <li>Contact information and addresses</li>
                                    <li>Debt amounts with source tracking</li>
                                    <li>Response status (responded/no response)</li>
                                    <li>Representative vs direct creditor info</li>
                                    <li>AI confidence levels and manual reviews</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h5 style="color: #495057; margin: 10px 0;">4. 🎯 Three-Tier Amount Priority System</h5>
                        <div style="background: white; padding: 15px; border-radius: 6px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #e9ecef;">
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Priority</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Amount Source</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Reliability</th>
                                        <th style="padding: 8px; border: 1px solid #dee2e6;">Usage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>1st</strong></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Creditor Response</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><span style="color: #28a745;">Highest ✓</span></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Current debt with interest/fees</td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>2nd</strong></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Original Document (AI)</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><span style="color: #ffc107;">Medium ⚠</span></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">AI-extracted from uploaded docs</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>3rd</strong></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">Default Fallback</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;"><span style="color: #dc3545;">Lowest ⚡</span></td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">€100 placeholder estimate</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Workflow Section -->
        <div id="status" class="section">
            <div class="flowchart-section">
                <h2>🔄 Status Workflow</h2>
                <p class="description">
                    The complete status progression showing how cases move through the system
                    from creation to completion.
                </p>
                <div class="mermaid">
                    stateDiagram-v2
                        [*] --> Created: New Client
                        Created --> PortalSent: Send Access
                        PortalSent --> DocsUploaded: Upload Documents
                        DocsUploaded --> Processing: AI Processing
                        Processing --> WaitPayment: Complete
                        WaitPayment --> Confirmed: Payment Made
                        Confirmed --> Review: 24h or Override
                        Review --> AwaitClient: Approved
                        AwaitClient --> Active: Client Confirms
                        Active --> Completed: All Done
                        Completed --> [*]
                        
                        Created --> Cancelled: No Response
                        PortalSent --> Cancelled: Inactive
                        WaitPayment --> Cancelled: No Payment
                        Cancelled --> [*]
                </div>
            </div>
        </div>

        <!-- Architecture Section -->
        <div id="architecture" class="section">
            <div class="flowchart-section">
                <h2>🏗️ System Architecture</h2>
                <p class="description">
                    High-level view of the system components and their interactions.
                </p>
                <div class="mermaid">
                    graph TB
                        subgraph "Frontend"
                            Client[Client Portal]
                            Admin[Admin Portal]
                            Agent[Agent Portal]
                        end
                        
                        subgraph "Backend"
                            API[Express API]
                            Services[Services Layer]
                            Tasks[Scheduled Tasks]
                        end
                        
                        subgraph "Data"
                            Mongo[(MongoDB)]
                            Files[File Storage]
                        end
                        
                        subgraph "External"
                            Zendesk[Zendesk API]
                            AI[Claude/OpenAI]
                            Email[Email Service]
                        end
                        
                        Client --> API
                        Admin --> API
                        Agent --> API
                        
                        API --> Services
                        API --> Tasks
                        
                        Services --> Mongo
                        Services --> Files
                        Tasks --> Mongo
                        
                        Services --> Zendesk
                        Services --> AI
                        Services --> Email
                        
                        style Client fill:#e3f2fd
                        style Admin fill:#fce4ec
                        style Agent fill:#e8f5e9
                </div>
            </div>
        </div>

        <!-- Admin Actions Section -->
        <div id="admin" class="section">
            <div class="flowchart-section">
                <h2>👨‍💼 Admin Actions Flow</h2>
                <p class="description">
                    Administrative functions including the immediate review button and user management.
                </p>
                <div class="mermaid">
                    graph LR
                        Admin([Admin Login]) --> Dash[Dashboard]
                        
                        Dash --> Actions{Select Action}
                        
                        Actions -->|Analytics| Stats[View Statistics]
                        Actions -->|Users| List[User List]
                        Actions -->|Settings| Config[System Config]
                        
                        List --> User[Select User]
                        User --> Details[View Details]
                        User --> Immediate{Immediate Review?}
                        
                        Immediate -->|Check| Valid{Valid State?}
                        Valid -->|Yes| Trigger[🔥 Trigger Now]
                        Valid -->|No| Error[Show Error]
                        
                        Trigger --> Cancel[Cancel 24h Delay]
                        Cancel --> Create[Create Zendesk Ticket]
                        Create --> Update[Update Status]
                        Update --> Success[✅ Success]
                        
                        style Trigger fill:#f8d7da
                        style Success fill:#d1e7dd
                </div>
            </div>
        </div>

        <!-- Document Calculations Section -->
        <div id="calculations" class="section">
            <div class="flowchart-section">
                <h2>📊 Document Calculations Explained</h2>
                <p class="description">
                    Detailed mathematical explanations of how the two generated documents (Schuldenbereinigungsplan and Forderungsübersicht) 
                    are calculated step-by-step with real examples.
                </p>

                <div style="margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
                    <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 24px;">📋 Document 1: Schuldenbereinigungsplan (Settlement Plan)</h3>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0;">🎯 Purpose & Content</h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Legal Document:</strong> Official settlement plan for court submission</li>
                            <li><strong>36-Month Plan:</strong> Complete payment schedule over 3 years</li>
                            <li><strong>Monthly Breakdown:</strong> Exact payment amount per creditor each month</li>
                            <li><strong>Garnishment Basis:</strong> Based on official German Pfändungstabelle 2025-2026</li>
                            <li><strong>Proportional Distribution:</strong> Fair allocation based on debt percentages</li>
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                        <h4 style="margin: 0 0 15px 0;">🧮 Step-by-Step Calculation Process</h4>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin: 15px 0; font-family: monospace;">
                            <strong>STEP 1: Determine Garnishable Income</strong><br/>
                            Input: Net Income = €3,000, Married + 1 Child = 2 Dependents<br/>
                            German Table Lookup → Garnishable Amount = €209.49/month
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin: 15px 0; font-family: monospace;">
                            <strong>STEP 2: Calculate Total Debt (3-Tier System)</strong><br/>
                            Creditor A: €5,000 (creditor response - highest priority)<br/>
                            Creditor B: €3,000 (AI extracted - medium priority)<br/>
                            Creditor C: €15,000 (creditor response - highest priority)<br/>
                            Creditor D: €100 (no data - default fallback)<br/>
                            <strong>TOTAL DEBT = €23,100</strong>
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin: 15px 0; font-family: monospace;">
                            <strong>STEP 3: Calculate Percentages & Monthly Payments</strong><br/>
                            Creditor A: €5,000 ÷ €23,100 = 21.65% → €45.34/month<br/>
                            Creditor B: €3,000 ÷ €23,100 = 12.99% → €27.20/month<br/>
                            Creditor C: €15,000 ÷ €23,100 = 64.94% → €136.02/month<br/>
                            Creditor D: €100 ÷ €23,100 = 0.43% → €0.90/month<br/>
                            <strong>TOTAL MONTHLY = €209.49</strong> ✓
                        </div>

                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; margin: 15px 0; font-family: monospace;">
                            <strong>STEP 4: 36-Month Total Calculations</strong><br/>
                            Creditor A: €45.34 × 36 = €1,632.24<br/>
                            Creditor B: €27.20 × 36 = €979.20<br/>
                            Creditor C: €136.02 × 36 = €4,896.72<br/>
                            Creditor D: €0.90 × 36 = €32.40<br/>
                            <strong>TOTAL 36-MONTH = €7,540.56</strong>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px;">
                    <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 24px;">📑 Document 2: Forderungsübersicht (Creditor Overview)</h3>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0;">🎯 Purpose & Content</h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Complete Database:</strong> Full list of all identified creditors</li>
                            <li><strong>Contact Information:</strong> Names, addresses, email addresses, phone numbers</li>
                            <li><strong>Debt Tracking:</strong> Original amounts vs final amounts with source attribution</li>
                            <li><strong>Response Status:</strong> Who responded to verification requests and who didn't</li>
                            <li><strong>AI Confidence:</strong> Machine learning confidence scores for data accuracy</li>
                            <li><strong>Representative Info:</strong> Distinguishes between direct creditors and collection agencies</li>
                        </ul>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                        <h4 style="margin: 0 0 15px 0;">📋 Detailed Data Fields Explanation</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px;">
                                <h5 style="margin: 0 0 10px 0;">👤 Creditor Identity</h5>
                                <ul style="margin: 0; padding-left: 15px; font-size: 14px;">
                                    <li><strong>Company Name:</strong> AI-extracted from documents</li>
                                    <li><strong>Address:</strong> Complete postal address</li>
                                    <li><strong>Contact Person:</strong> If specified in documents</li>
                                    <li><strong>Reference Number:</strong> Case/account numbers</li>
                                </ul>
                            </div>

                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px;">
                                <h5 style="margin: 0 0 10px 0;">💰 Amount Calculation</h5>
                                <ul style="margin: 0; padding-left: 15px; font-size: 14px;">
                                    <li><strong>Original Amount:</strong> AI-extracted from uploaded docs</li>
                                    <li><strong>Updated Amount:</strong> From 30-day creditor responses</li>
                                    <li><strong>Final Amount:</strong> Determined by 3-tier priority system</li>
                                    <li><strong>Source Attribution:</strong> Where the final amount came from</li>
                                </ul>
                            </div>

                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px;">
                                <h5 style="margin: 0 0 10px 0;">📊 Data Quality Metrics</h5>
                                <ul style="margin: 0; padding-left: 15px; font-size: 14px;">
                                    <li><strong>AI Confidence:</strong> 0-100% accuracy score</li>
                                    <li><strong>Manual Review Flag:</strong> If human verification needed</li>
                                    <li><strong>Data Completeness:</strong> How much info was extracted</li>
                                    <li><strong>Validation Status:</strong> Passed automated checks</li>
                                </ul>
                            </div>

                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px;">
                                <h5 style="margin: 0 0 10px 0;">📞 Contact Status Tracking</h5>
                                <ul style="margin: 0; padding-left: 15px; font-size: 14px;">
                                    <li><strong>Contact Date:</strong> When verification email was sent</li>
                                    <li><strong>Response Status:</strong> Responded/No Response/Email Failed</li>
                                    <li><strong>Response Date:</strong> When creditor replied</li>
                                    <li><strong>Updated Information:</strong> New amounts or corrections</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="padding: 25px; background: #f8f9fa; border-radius: 12px; border-left: 6px solid #28a745;">
                    <h3 style="margin: 0 0 20px 0; color: #155724;">🔍 Real Example: Complete Calculation Walkthrough</h3>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin: 0 0 15px 0;">📝 Case Study: Max Mustermann</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h5 style="color: #6c757d;">Financial Situation:</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                                    <li>Net Income: €2,800/month</li>
                                    <li>Married: Yes</li>
                                    <li>Children: 2</li>
                                    <li>Total Dependents: 3 (wife + 2 children)</li>
                                    <li><strong>Garnishable Amount: €169.42/month</strong></li>
                                </ul>
                            </div>
                            <div>
                                <h5 style="color: #6c757d;">Documents Uploaded:</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                                    <li>15 creditor documents</li>
                                    <li>12 successfully processed (≥80% confidence)</li>
                                    <li>2 requiring manual review (<80%)</li>
                                    <li>1 no text detected (scanned poorly)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #495057; margin: 0 0 15px 0;">📊 Final Creditor Amounts (After 30-Day Responses)</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #e9ecef;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Creditor</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Original (AI)</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Response</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Final Amount</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Source</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">%</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6;">Monthly</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Telekom AG</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€2,400</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€2,750</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>€2,750</strong></td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Creditor Response</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">19.3%</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€32.70</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Stadtwerke GmbH</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€850</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">No Response</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>€850</strong></td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Original Document</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">6.0%</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€10.12</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Bank Credit</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€8,500</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€9,200</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>€9,200</strong></td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Creditor Response</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">64.5%</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€109.29</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Insurance Co</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€1,200</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">No Response</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>€1,200</strong></td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Original Document</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">8.4%</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€14.28</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Unknown Creditor</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">N/A</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">No Response</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>€100</strong></td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">Default Fallback</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">0.7%</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€1.18</td>
                                </tr>
                                <tr style="background: #e9ecef; font-weight: bold;">
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">TOTAL</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">-</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">-</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€14,100</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">-</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">100%</td>
                                    <td style="padding: 8px; border: 1px solid #dee2e6;">€169.42</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border-radius: 6px; border-left: 4px solid #bee5eb;">
                            <strong>📈 Result:</strong> Max will pay €169.42/month for 36 months = €6,099.12 total settlement amount.
                            This represents 43.3% of the total debt (€14,100), which is typical for German insolvency settlements.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#fff',
                primaryTextColor: '#333',
                primaryBorderColor: '#9f1a1d',
                lineColor: '#333',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#fff'
            }
        });

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Mark the clicked tab as active
            event.target.classList.add('active');
            
            // Re-render Mermaid diagrams
            mermaid.init();
        }
    </script>
</body>
</html>