---
phase: 04-code-based-merge-logic
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/services/deduplicator.py
  - tests/test_merge_creditors.py
autonomous: true

must_haves:
  truths:
    - "merge_creditor_group() merges a list of creditor dicts into a single dict using deterministic field-priority rules"
    - "Field merge prefers non-empty, non-N/A values; among valid values, longest string wins"
    - "claim_amount merge picks the highest numeric value; ignores strings and None"
    - "needs_manual_review is True if ANY creditor in the group had it True"
    - "is_representative is True if ANY creditor in the group had it True"
    - "source_documents combines all documents from group members without duplicates, preserving order"
    - "Representative groups preserve sender_name from representative and actual_creditor from actual creditor"
    - "All-N/A fields become None, not 'N/A'"
    - "review_reasons combines all reasons from group members without duplicates"
    - "Non-merge fields (document_id, timestamps, etc.) come from first creditor in group"
  artifacts:
    - path: "app/services/deduplicator.py"
      provides: "merge_creditor_group and helper functions"
      contains: "def merge_creditor_group"
    - path: "tests/test_merge_creditors.py"
      provides: "Unit tests for all merge behaviors"
      contains: "test_merge"
  key_links:
    - from: "merge_creditor_group"
      to: "_merge_field"
      via: "internal call for string field merging"
      pattern: "_merge_field"
    - from: "merge_creditor_group"
      to: "_merge_claim_amount"
      via: "internal call for numeric amount merging"
      pattern: "_merge_claim_amount"
    - from: "merge_creditor_group"
      to: "_merge_representative_fields"
      via: "internal call when group has is_representative=True"
      pattern: "_merge_representative_fields"
    - from: "merge_creditor_group"
      to: "_merge_source_documents"
      via: "internal call for document list deduplication"
      pattern: "_merge_source_documents"
---

<objective>
Implement and test the deterministic creditor merge function that consolidates duplicate groups identified by the LLM into single creditor records.

Purpose: Satisfies MERGE-01 through MERGE-07. Replaces Phase 3's placeholder merge (keep-first-creditor) with field-priority logic that picks the best value for each field, handles representative creditors, and combines lists.

Output: `merge_creditor_group()` function with helpers in `deduplicator.py`, plus comprehensive unit tests in `tests/test_merge_creditors.py`.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-based-merge-logic/04-CONTEXT.md
@.planning/phases/04-code-based-merge-logic/04-RESEARCH.md

Source file to modify (FastAPI service — DIFFERENT repo):
@/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/app/services/deduplicator.py

Prior plan summary (Phase 3 context — provides LLM group output format):
@.planning/phases/03-llm-prompt-optimization/03-02-SUMMARY.md
</context>

<feature>
  <name>Deterministic Creditor Merge Logic</name>
  <files>
    /Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/app/services/deduplicator.py
    /Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/tests/test_merge_creditors.py
  </files>
  <behavior>
    merge_creditor_group(creditors: List[dict]) -> dict

    Takes a list of creditor dicts (from a single LLM-identified duplicate group) and returns one merged creditor dict.

    **Field-by-field merge rules:**

    1. String fields (sender_name, sender_address, sender_email, reference_number, claim_amount_raw, dokumenttyp, glaeubiger_name, glaeubiger_adresse, glaeubigervertreter_name, glaeubigervertreter_adresse, forderungbetrag, email_glaeubiger, email_glaeubiger_vertreter):
       - Filter out empty strings, None, and "N/A" (case-insensitive)
       - Among remaining valid values, pick the longest string
       - If all values are empty/N/A, return None
       - Input: ["Deutsche Bank AG", "N/A", "Deutsche Bank"] -> "Deutsche Bank AG"
       - Input: ["N/A", "", "N/A"] -> None
       - Input: ["Vodafone", "Vodafone GmbH"] -> "Vodafone GmbH"

    2. claim_amount (MERGE-05):
       - Extract only numeric values (int or float, > 0)
       - Pick the highest numeric value
       - If no numeric values exist, return None
       - Input: [500.0, 750.0, None] -> 750.0
       - Input: ["N/A", None, ""] -> None

    3. needs_manual_review (MERGE-03):
       - OR logic: True if ANY creditor has it True
       - Input: [False, True, False] -> True
       - Input: [False, False] -> False

    4. is_representative (MERGE-07):
       - OR logic: True if ANY creditor has it True

    5. source_documents (MERGE-04):
       - Combine from all creditors, deduplicate preserving order
       - Handle both list and string source_documents values
       - Fall back to source_document or filename fields if source_documents missing
       - Input: [["doc1.pdf", "doc2.pdf"], ["doc2.pdf", "doc3.pdf"]] -> ["doc1.pdf", "doc2.pdf", "doc3.pdf"]

    6. review_reasons:
       - Combine all reasons, deduplicate preserving order
       - Filter out None/empty

    7. Representative handling (MERGE-06):
       - If ANY creditor has is_representative=True:
         - sender_name = representative's sender_name
         - actual_creditor = rep's actual_creditor field, or non-rep creditor's sender_name as fallback
       - If NO representative: actual_creditor = None

    8. Non-merge fields (document_id, document_status, document_confidence, verification):
       - Keep from first creditor in group

    9. Metadata:
       - merged_from = len(creditors)

    **Edge cases:**
    - Empty list -> {}
    - Single creditor -> pass through with normalized source_documents and merged_from=1
    - All N/A for a field -> None (not "N/A")
    - No numeric claim_amounts -> None
    - Multiple creditors, no representative -> regular merge for all fields
  </behavior>
  <implementation>
    Add the following functions as module-level functions in deduplicator.py, in the section below the existing LLM Prompt Infrastructure section and above the CreditorDeduplicator class.

    Add a new section header comment:
    ```python
    # ========================================
    # Merge Logic (Phase 4)
    # ========================================
    ```

    **Helper functions (private, prefixed with _):**

    1. `_merge_field(values: List[Any]) -> Optional[str]` — Generic string field merge: filter N/A/empty, pick longest
    2. `_merge_claim_amount(creditors: List[dict]) -> Optional[float]` — Numeric priority, highest wins
    3. `_merge_needs_manual_review(creditors: List[dict]) -> bool` — OR logic via any()
    4. `_merge_source_documents(creditors: List[dict]) -> List[str]` — Combine + deduplicate with dict.fromkeys()
    5. `_merge_review_reasons(creditors: List[dict]) -> List[str]` — Combine + deduplicate
    6. `_merge_representative_fields(merged: dict, creditors: List[dict]) -> dict` — Set sender_name to rep's name, actual_creditor to actual name

    **Main function:**
    7. `merge_creditor_group(creditors: List[dict]) -> dict` — Orchestrates all helpers

    See 04-RESEARCH.md "Code Examples" section for detailed implementation patterns. Follow those patterns closely.

    **Important implementation details:**
    - Always copy first creditor with `dict(creditors[0])` — never mutate originals
    - German mirror fields (glaeubiger_name, glaeubiger_adresse, etc.) should get same value as their English counterparts (sender_name, sender_address, etc.) after merge
    - Merge the German-only fields that have no English equivalent (glaeubigervertreter_name, glaeubigervertreter_adresse, email_glaeubiger_vertreter) using _merge_field
    - email_glaeubiger should match sender_email after merge
    - forderungbetrag should match claim_amount_raw after merge

    **Test file structure:**
    Create `/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/tests/test_merge_creditors.py`.
    Create the `tests/` directory if it doesn't exist.

    Required test cases (minimum):
    1. test_merge_empty_list — returns {}
    2. test_merge_single_creditor — pass-through with merged_from=1
    3. test_merge_prefers_non_na — non-N/A wins over N/A
    4. test_merge_prefers_longest — longest valid string wins
    5. test_merge_all_na_becomes_none — all N/A -> None
    6. test_merge_claim_amount_highest_numeric — highest float wins
    7. test_merge_claim_amount_no_numeric — all None/strings -> None
    8. test_merge_needs_manual_review_or_logic — True if any True
    9. test_merge_needs_manual_review_all_false — False if all False
    10. test_merge_is_representative_or_logic — True if any True
    11. test_merge_source_documents_deduplicated — combines and deduplicates
    12. test_merge_source_documents_handles_string — single string converted to list
    13. test_merge_representative_preserves_both_names — sender_name=rep, actual_creditor=actual
    14. test_merge_representative_fallback_to_non_rep_name — actual_creditor from non-rep's sender_name when rep's actual_creditor is N/A
    15. test_merge_non_merge_fields_from_first — document_id etc. from first creditor
    16. test_merge_review_reasons_combined — combines and deduplicates reasons
    17. test_merge_idempotent — running merge twice on same input produces same output
    18. test_merge_does_not_mutate_input — original creditor dicts unchanged after merge
  </implementation>
</feature>

<verification>
After TDD cycle completes, verify:
1. All test cases pass: `cd "/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI" && python -m pytest tests/test_merge_creditors.py -v`
2. `merge_creditor_group` exists as a module-level function in deduplicator.py
3. All 6 helper functions exist with underscore prefix
4. File still parses as valid Python: `python -c "import ast; ast.parse(open('app/services/deduplicator.py').read())"`
5. No existing functions/methods are modified — only new code added
</verification>

<success_criteria>
- MERGE-01: merge_creditor_group() applies deterministic rules (longest string, highest amount, OR booleans)
- MERGE-02: _merge_field() filters N/A and picks longest; all-N/A returns None
- MERGE-03: needs_manual_review uses any() OR logic
- MERGE-04: source_documents deduplicates with dict.fromkeys() preserving order
- MERGE-05: claim_amount picks highest numeric value, ignores non-numeric
- MERGE-06: Representative groups set sender_name=rep, actual_creditor=actual
- MERGE-07: is_representative uses any() OR logic
- All 18+ test cases pass
- Merge function does not mutate input creditor dicts
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-based-merge-logic/04-01-SUMMARY.md`
</output>
