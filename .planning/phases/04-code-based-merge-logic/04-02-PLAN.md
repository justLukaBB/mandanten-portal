---
phase: 04-code-based-merge-logic
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/services/deduplicator.py
autonomous: true

must_haves:
  truths:
    - "deduplicate_with_llm() calls merge_creditor_group() for duplicate groups instead of using the simple keep-first-creditor placeholder"
    - "Singleton groups still pass through without calling merge_creditor_group()"
    - "The fallback error handler still returns original creditors unchanged on failure"
    - "Result creditor count equals LLM group count (no data loss)"
    - "merged_from field reflects actual group size for both singletons and duplicates"
  artifacts:
    - path: "app/services/deduplicator.py"
      provides: "deduplicate_with_llm() wired to merge_creditor_group()"
      contains: "merge_creditor_group"
  key_links:
    - from: "deduplicate_with_llm"
      to: "merge_creditor_group"
      via: "called for each duplicate group (len > 1)"
      pattern: "merge_creditor_group\\("
---

<objective>
Wire merge_creditor_group() into the live deduplicate_with_llm() method, replacing the Phase 3 placeholder merge logic.

Purpose: The placeholder merge (lines 489-528) keeps only the first creditor and combines source_documents. This plan replaces it with the deterministic merge function from Plan 04-01, completing the Phase 4 integration.

Output: deduplicate_with_llm() calls merge_creditor_group() for all duplicate groups (group size > 1).
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-based-merge-logic/04-CONTEXT.md

Prior plan summary (merge functions created in Plan 01):
@.planning/phases/04-code-based-merge-logic/04-01-SUMMARY.md

Source file to modify (FastAPI service — DIFFERENT repo):
@/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/app/services/deduplicator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace placeholder merge with merge_creditor_group() call</name>
  <files>/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/app/services/deduplicator.py</files>
  <action>
In the `deduplicate_with_llm()` method, replace the duplicate group merge block (the `else:` branch that starts with `# Duplicate group — simple merge (Phase 4 will improve)`) with a call to `merge_creditor_group()`.

**Current code to replace** (approximately lines 489-528):
```python
else:
    # Duplicate group — simple merge (Phase 4 will improve)
    primary = dict(creditors[group[0]])  # Copy first as base

    # Combine source_documents from all group members
    all_src_docs = []
    seen_docs = set()
    any_needs_review = False
    all_review_reasons = []

    for idx in group:
        c = creditors[idx]
        # Collect source documents
        src_docs = c.get("source_documents")
        if isinstance(src_docs, str):
            src_docs = [src_docs]
        if not src_docs:
            src_docs = [c.get("source_document") or c.get("filename") or "unknown"]
        for doc in src_docs:
            if doc not in seen_docs:
                seen_docs.add(doc)
                all_src_docs.append(doc)

        # OR logic for needs_manual_review
        if c.get("needs_manual_review"):
            any_needs_review = True

        # Collect review reasons
        reasons = c.get("review_reasons", [])
        if isinstance(reasons, list):
            for r in reasons:
                if r and r not in all_review_reasons:
                    all_review_reasons.append(r)

    primary["source_documents"] = all_src_docs
    primary["merged_from"] = len(group)
    primary["needs_manual_review"] = any_needs_review or primary.get("needs_manual_review", False)
    primary["review_reasons"] = all_review_reasons if all_review_reasons else primary.get("review_reasons", [])

    result.append(primary)
```

**Replace with:**
```python
else:
    # Duplicate group — deterministic merge (Phase 4)
    group_creditors = [creditors[idx] for idx in group]
    merged = merge_creditor_group(group_creditors)
    result.append(merged)
```

Also update the method docstring to remove the Phase 4 caveat. Change:
```
Until Phase 4 merging is implemented,
the first creditor in each group is kept as the representative, with
combined source_documents.
```
To:
```
Phase 4 merge logic deterministically combines field values from
duplicate creditors using priority rules (non-N/A, longest, highest amount).
```

And update the Step 4 comment from:
```python
# Step 4: Reconstruct creditor list from groups
# Until Phase 4 (code-based merge), use simple strategy:
# - For each group, keep the first creditor as representative
# - Combine source_documents from all creditors in the group
# - Set merged_from to group size
# - Preserve needs_manual_review with OR logic
```
To:
```python
# Step 4: Merge groups using deterministic rules (Phase 4)
# - Singletons: pass through with normalized source_documents
# - Duplicate groups: merge_creditor_group() applies field priority rules
```

Do NOT modify the singleton branch (the `if len(group) == 1:` block) — it already works correctly.

Do NOT modify the error fallback (`except Exception as e:` block) — it should still return original creditors unchanged on failure.
  </action>
  <verify>
Read the modified `deduplicate_with_llm()` method and confirm:
1. The `else:` branch calls `merge_creditor_group(group_creditors)` (not the old 40-line inline merge)
2. The singleton branch (`if len(group) == 1:`) is unchanged
3. The error fallback (`except Exception as e:`) is unchanged
4. The method docstring references Phase 4 merge logic (not "Until Phase 4")
5. File parses as valid Python: `python -c "import ast; ast.parse(open('app/services/deduplicator.py').read())"`
6. Run existing tests if any: `cd "/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI" && python -m pytest tests/ -v 2>/dev/null || echo "No test suite configured"`
  </verify>
  <done>
deduplicate_with_llm() calls merge_creditor_group() for all duplicate groups. The 40-line inline merge is replaced by a 3-line call. Singleton handling and error fallback remain unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end merge integration</name>
  <files>/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI/app/services/deduplicator.py</files>
  <action>
Verify that the wiring is correct by tracing the full flow and checking for potential issues:

1. **Import check:** `merge_creditor_group` is defined at module level in the same file, so no import needed. Verify it is defined ABOVE the `CreditorDeduplicator` class (where `deduplicate_with_llm` lives).

2. **Data flow check:** Trace that `group_creditors = [creditors[idx] for idx in group]` produces the correct list — `creditors` is the input parameter, `group` is a list of integer indices from `validated.groups`.

3. **Return shape check:** `merge_creditor_group()` returns a dict with all expected fields including `source_documents` (list), `merged_from` (int), `needs_manual_review` (bool). This matches what the old inline code produced and what downstream consumers (Node.js webhook) expect.

4. **Count invariant check:** After the for loop, verify that `len(result) == len(validated.groups)`. Add a debug log line AFTER the for loop completes (before the existing logger.info line):
```python
# Verify no creditors lost during merge
assert len(result) == len(validated.groups), (
    f"Merge produced {len(result)} creditors but expected {len(validated.groups)} groups"
)
```

5. **Log message update:** The existing log message at line ~530 says:
```python
f"Deduplication complete: {len(creditors)} -> {len(result)} unique creditors "
f"({len(creditors) - len(result)} duplicates removed)"
```
This is still correct and needs no change.

6. **File syntax check:** Run `python -c "import ast; ast.parse(open('app/services/deduplicator.py').read())"` to verify the file is valid Python.

7. **Run unit tests:** Run `cd "/Users/luka.s/Cursor : Mandanten - Portal/Creditor-process-fastAPI" && python -m pytest tests/test_merge_creditors.py -v` to confirm merge tests still pass after integration.
  </action>
  <verify>
1. `merge_creditor_group` is defined before `CreditorDeduplicator` class in deduplicator.py
2. The assert statement is present after the merge loop
3. All unit tests pass: `python -m pytest tests/test_merge_creditors.py -v`
4. File is valid Python: `python -c "import ast; ast.parse(open('app/services/deduplicator.py').read())"`
  </verify>
  <done>
End-to-end integration verified: merge_creditor_group() is reachable from deduplicate_with_llm(), data flow is correct, count invariant is asserted, and all unit tests pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. `deduplicator.py` no longer contains the 40-line inline merge block (the "Phase 4 will improve" comment is gone)
2. `deduplicate_with_llm()` calls `merge_creditor_group()` for duplicate groups
3. Singleton handling is unchanged
4. Error fallback is unchanged
5. Count invariant assertion is present
6. All merge unit tests pass
7. File is valid Python
</verification>

<success_criteria>
- The Phase 3 placeholder merge is completely replaced by merge_creditor_group()
- deduplicate_with_llm() is ~40 lines shorter (inline merge removed)
- Data flow: LLM groups -> extract creditors by index -> merge_creditor_group() -> result list
- No behavioral regression for singletons or error fallback
- Count invariant: len(result) == len(validated.groups)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-based-merge-logic/04-02-SUMMARY.md`
</output>
