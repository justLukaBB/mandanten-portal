---
phase: 08-fastapi-pdf-support
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - /tmp/creditor-fastapi/app/services/document_processor.py
  - /tmp/creditor-fastapi/app/routers/processing.py
autonomous: false

must_haves:
  truths:
    - "PDF file uploaded through the full pipeline is processed end-to-end without errors"
    - "Image file uploaded through the full pipeline still works identically"
    - "Multi-creditor PDF produces separate DocumentResult entries with creditor_index"
    - "MIME type from FileInfo is logged during processing for observability"
  artifacts:
    - path: "/tmp/creditor-fastapi/app/routers/processing.py"
      provides: "MIME type logging in process_documents_task"
      contains: "mime_type"
    - path: "/tmp/creditor-fastapi/app/services/document_processor.py"
      provides: "process_document accepts optional mime_type parameter"
      contains: "mime_type"
  key_links:
    - from: "/tmp/creditor-fastapi/app/routers/processing.py"
      to: "/tmp/creditor-fastapi/app/services/document_processor.py"
      via: "process_document called with mime_type from FileInfo"
      pattern: "process_document.*mime_type"
---

<objective>
Wire MIME type metadata through the processing pipeline and verify PDF processing works end-to-end.

Purpose: Plan 01 added PDF support to `_load_image_as_part()` using file extension detection, which works because the temp file preserves the original filename. This plan adds explicit MIME type logging from the FileInfo metadata for observability, and verifies the complete flow with a real PDF upload.

Output: Updated processing pipeline with MIME type awareness, verified end-to-end PDF processing.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-fastapi-pdf-support/08-CONTEXT.md
@.planning/phases/08-fastapi-pdf-support/08-RESEARCH.md
@.planning/phases/08-fastapi-pdf-support/08-01-SUMMARY.md

IMPORTANT: The FastAPI service is in a SEPARATE repo at /tmp/creditor-fastapi/ (cloned from github.com/justLukaBB/Creditor-process-fastAPI, branch: fix/over-aggressive-dedup).

Key codebase facts:
- `FileInfo` model has `mime_type` field (default: "image/png") passed from Node.js
- `process_documents_task()` in routers/processing.py iterates over files, downloads to temp dir, calls `processor.process_document(image_path, filename, document_id)` - does NOT pass mime_type
- `process_document()` in document_processor.py takes `image_path`, `filename`, `document_id` - no mime_type param
- Plan 01 added PDF support via file extension detection (.pdf -> application/pdf), which works because temp files keep original filename
- Adding explicit MIME type threading provides: better logging, defense-in-depth (if filename extension doesn't match), future extensibility
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread MIME type through processing pipeline for observability</name>
  <files>/tmp/creditor-fastapi/app/services/document_processor.py, /tmp/creditor-fastapi/app/routers/processing.py</files>
  <action>
1. **Update `process_document()` signature** in `document_processor.py` to accept an optional `mime_type` parameter:

   Change:
   ```python
   async def process_document(
       self,
       image_path: str,
       filename: str,
       document_id: str = None
   ) -> DocumentResult:
   ```
   To:
   ```python
   async def process_document(
       self,
       image_path: str,
       filename: str,
       document_id: str = None,
       mime_type: str = None
   ) -> DocumentResult:
   ```

2. **Add MIME type logging** at the start of `process_document()`, right after the `doc_id` assignment:
   ```python
   # Log MIME type for observability
   detected_ext = os.path.splitext(image_path)[1].lower()
   logger.info(f"Processing document: {filename} (mime_type={mime_type or 'not provided'}, ext={detected_ext}, doc_id={doc_id})")
   ```

3. **Use MIME type for PDF detection** as a fallback. Update the is_pdf check in Step 3 (rotation skip) to also consider the passed mime_type:
   ```python
   # Step 3: Rotation analysis and correction (images only - PDFs don't need rotation)
   is_pdf = os.path.splitext(image_path)[1].lower() == '.pdf' or mime_type == 'application/pdf'
   ```
   This provides defense-in-depth: if somehow the temp file doesn't have .pdf extension but the MIME type says PDF, rotation is still skipped.

4. **Update the caller in `process_documents_task()`** in `routers/processing.py`. Find the line:
   ```python
   result = await processor.process_document(image_path, filename, document_id)
   ```
   Change to:
   ```python
   result = await processor.process_document(
       image_path, filename, document_id,
       mime_type=file_info.mime_type
   )
   ```
   This passes the MIME type from the FileInfo model (which comes from Node.js) through to the processor.

5. **Add MIME type logging** in the file processing loop in `process_documents_task()`, right before the `process_document` call:
   ```python
   logger.info(f"Processing document: {filename} (mime_type={file_info.mime_type}, size={file_info.size})")
   ```

IMPORTANT: Do NOT change the `_load_image_as_part()` method. It correctly uses file extension detection (Plan 01). The MIME type parameter in `process_document` is for logging and the rotation-skip check only.
  </action>
  <verify>
  1. Grep for `mime_type` parameter in `process_document` signature in document_processor.py
  2. Grep for `mime_type=file_info.mime_type` in processing.py to confirm it's passed through
  3. Grep for `is_pdf.*mime_type` in document_processor.py to confirm dual detection
  4. Run `cd /tmp/creditor-fastapi && python -c "from app.services.document_processor import DocumentProcessor; print('Import OK')"` to verify no import errors
  </verify>
  <done>
  - `process_document()` accepts optional `mime_type` parameter
  - MIME type is logged at processing start for observability
  - PDF detection for rotation skip uses both file extension AND mime_type (defense-in-depth)
  - `process_documents_task()` passes `file_info.mime_type` to `process_document()`
  - No changes to `_load_image_as_part()` (uses file extension detection from Plan 01)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete PDF processing support in FastAPI:
  1. pypdf dependency added for PDF validation
  2. `_validate_pdf()` rejects encrypted, oversized, and corrupted PDFs
  3. `_load_image_as_part()` handles .pdf extension, creates Gemini Part with application/pdf MIME type
  4. `process_document()` skips rotation for PDFs, accepts MIME type for observability
  5. Processing pipeline threads MIME type from FileInfo through to processor
  6. All existing image processing unchanged (backward compatible)
  </what-built>
  <how-to-verify>
  Test the complete FastAPI service with PDF processing:

  1. Start the FastAPI service locally:
     ```bash
     cd /tmp/creditor-fastapi
     pip install -r requirements.txt
     uvicorn app.main:app --reload --port 8000
     ```

  2. Test with a sample PDF - upload a real creditor document PDF through the Node.js backend (or directly via FastAPI's /processing/jobs endpoint with a GCS-hosted PDF).

  3. Verify in FastAPI logs:
     - "PDF validated: X pages, Y.ZMB" appears
     - "Loading PDF as Gemini Part: X pages, Y.ZMB" appears
     - "Skipping rotation analysis for PDF: filename.pdf" appears
     - Gemini processes the PDF and returns creditor data
     - No errors related to PIL or rotation

  4. Test backward compatibility: upload a regular JPG/PNG image and verify it still works identically (rotation analysis runs, extraction works).

  5. Test error cases (optional):
     - Upload a password-protected PDF -> should get "Password-protected PDFs are not supported"
     - Upload a corrupted file with .pdf extension -> should get "PDF file is corrupted or invalid"

  Expected: PDF uploads are processed end-to-end by Gemini, creditor data is extracted, webhook is sent. Image uploads continue to work identically.
  </how-to-verify>
  <resume-signal>Type "approved" if PDF processing works end-to-end, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `process_document()` accepts `mime_type` parameter
2. MIME type is logged during processing
3. PDF detection for rotation skip uses both extension and MIME type
4. `process_documents_task()` passes MIME type from FileInfo
5. User has verified end-to-end PDF processing works
6. User has verified image processing backward compatibility
</verification>

<success_criteria>
- PDF-01: Complete - PDF files processed end-to-end through FastAPI/Gemini pipeline
- ERR-01: Complete - Bad PDFs rejected with clear error messages
- COMPAT-01: Complete - Image uploads work identically to before
- MIME type metadata flows through pipeline for observability
- User has manually verified the feature works
</success_criteria>

<output>
After completion, create `.planning/phases/08-fastapi-pdf-support/08-02-SUMMARY.md`
</output>
