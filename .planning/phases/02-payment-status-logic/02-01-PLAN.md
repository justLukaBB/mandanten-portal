---
phase: 02-payment-status-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/controllers/zendeskWebhookController.js
autonomous: true

must_haves:
  truths:
    - "Payment handler checks creditor.needs_manual_review flag before any contact field checks"
    - "If ANY creditor has needs_manual_review=true, status routes to creditor_review regardless of contact data"
    - "Auto-approval only happens when ALL creditors have needs_manual_review=false AND have email, address, and name"
    - "Empty final_creditor_list routes to creditor_review (abnormal state)"
    - "Creditor name is checked alongside email and address for auto-approval"
  artifacts:
    - path: "server/controllers/zendeskWebhookController.js"
      provides: "Updated payment handler with creditor-level needs_manual_review check"
      contains: "creditor.needs_manual_review === true"
  key_links:
    - from: "creditorNeedsManualReview() helper"
      to: "creditor.needs_manual_review field"
      via: "Direct boolean check as first condition"
      pattern: "creditor\\.needs_manual_review === true"
    - from: "creditorNeedsManualReview() helper"
      to: "creditor name fields"
      via: "isMissingValue check on sender_name/glaeubiger_name"
      pattern: "missingName"
---

<objective>
Modify the payment handler's creditor review logic to check the creditor-level `needs_manual_review` flag and creditor name, alongside existing contact field checks. Route to `creditor_review` if ANY creditor needs review or is missing required contact information.

Purpose: This is the core fix — currently the payment handler ignores `creditor.needs_manual_review` (line 539 comment: "using document flags, NOT creditor.needs_manual_review"), causing creditors flagged during AI deduplication to bypass agent review.

Output: Modified `creditorNeedsManualReview()` helper that checks: (1) needs_manual_review flag, (2) email, (3) address, (4) name. Plus empty creditor list guard.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-payment-status-logic/02-CONTEXT.md
@.planning/phases/02-payment-status-logic/02-RESEARCH.md
@server/controllers/zendeskWebhookController.js
@server/models/Client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add needs_manual_review flag check and name validation to creditorNeedsManualReview helper</name>
  <files>server/controllers/zendeskWebhookController.js</files>
  <action>
Modify the `creditorNeedsManualReview()` helper function (lines 513-537) in `handleUserPaymentConfirmed()` to:

1. **Check `creditor.needs_manual_review` flag FIRST** (before any document or contact checks):
   ```javascript
   if (creditor.needs_manual_review === true) {
       return true;
   }
   ```
   This must be the FIRST check in the function, before document flag checks and contact field checks.

2. **Add creditor name check** alongside existing email/address checks. The current code checks email and address but NOT name. Add:
   ```javascript
   const creditorName = creditor.sender_name || creditor.glaeubiger_name;
   const missingName = isMissingValue(creditorName);
   ```
   And include `missingName` in the return condition alongside `missingEmail` and `missingAddress`.

3. **Check all field name variants** using OR logic for each contact field:
   - Email: `creditor.sender_email || creditor.email_glaeubiger`
   - Address: `creditor.sender_address || creditor.glaeubiger_adresse`
   - Name: `creditor.sender_name || creditor.glaeubiger_name`

4. **Remove the document flag checking logic** (the linked document lookup and `documentNeedsReview` check at lines 514-527). The research and context documents confirm: "The payment handler logic only checks creditor-level fields (not document processing status)." The `needs_manual_review` flag on the creditor (set during dedup/document processing) replaces the need to traverse linked documents for flags.

5. **Update the comment on line 539** from "using document flags, NOT creditor.needs_manual_review" to reflect the new logic — the function now checks the creditor-level flag and contact completeness.

6. **Update console.log messages** (lines 543-549) to reflect the new checking logic. Change "from doc flags" references to accurately describe what's being checked (needs_manual_review flag + contact completeness).

The updated helper should look like:
```javascript
// Helper to check if creditor needs review (creditor flag + missing contact info)
const creditorNeedsManualReview = (creditor) => {
    // Check 1: Creditor-level manual review flag (set by AI dedup)
    if (creditor.needs_manual_review === true) {
        return true;
    }

    // Check 2: Missing contact fields (email, address, name)
    const creditorEmail = creditor.sender_email || creditor.email_glaeubiger;
    const creditorAddress = creditor.sender_address || creditor.glaeubiger_adresse;
    const creditorName = creditor.sender_name || creditor.glaeubiger_name;

    const missingEmail = isMissingValue(creditorEmail);
    const missingAddress = isMissingValue(creditorAddress);
    const missingName = isMissingValue(creditorName);

    return missingEmail || missingAddress || missingName;
};
```

IMPORTANT: Do NOT change field names `creditor.email` or `creditor.address` to non-existent field names. The creditor schema (Client.js:80-184) defines: `sender_email`, `email_glaeubiger`, `sender_address`, `glaeubiger_adresse`, `sender_name`, `glaeubiger_name`. Use these exact schema field names.
  </action>
  <verify>
1. Read the modified function and confirm:
   - `creditor.needs_manual_review === true` is the FIRST check
   - No document flag traversal code remains
   - Email check uses `sender_email || email_glaeubiger`
   - Address check uses `sender_address || glaeubiger_adresse`
   - Name check uses `sender_name || glaeubiger_name`
   - All three contact checks use `isMissingValue()`
2. Run: `node -e "require('./server/controllers/zendeskWebhookController')"` from project root to verify no syntax errors
  </verify>
  <done>
The creditorNeedsManualReview helper checks needs_manual_review flag first, then validates email + address + name using correct schema field names and isMissingValue() helper. Document flag traversal is removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add empty creditor list guard and update status decision logging</name>
  <files>server/controllers/zendeskWebhookController.js</files>
  <action>
In `handleUserPaymentConfirmed()`, make two changes:

1. **Add empty creditor list guard** — BEFORE the `needsReview` filter (currently at line 540), add:
   ```javascript
   // Edge case: Empty creditor list is abnormal after payment — route to review
   if (creditors.length === 0) {
       console.log(`[payment-handler] No creditors found for ${freshClient.aktenzeichen} — routing to creditor_review`);
       // Fall through to the needsReview > 0 path by treating as needs review
   }
   ```

   Then modify the status decision (currently at line 567) to also route to `creditor_review` when `creditors.length === 0`. The simplest approach: change the condition from `needsReview.length > 0` to `needsReview.length > 0 || creditors.length === 0`.

   Apply this same condition change to ALL places where `needsReview.length > 0` or `needsReview.length === 0` is used as the branching condition (lines 553, 561, 567, 571, 591, 612, 614, 640, 675, 679, 684, 697, 698, 709). Use a computed boolean for clarity:
   ```javascript
   const requiresManualReview = needsReview.length > 0 || creditors.length === 0;
   ```
   Then replace all `needsReview.length > 0` with `requiresManualReview` and all `needsReview.length === 0` with `!requiresManualReview`.

2. **Update the console.log analysis block** (lines 543-549) to log the actual reasons:
   ```javascript
   console.log(`[payment-handler] Creditor analysis for ${freshClient.aktenzeichen}:`);
   console.log(`   Total creditors: ${creditors.length}`);
   console.log(`   Creditors needing review: ${needsReview.length}`);
   needsReview.forEach(c => {
       const reasons = [];
       if (c.needs_manual_review === true) reasons.push('needs_manual_review');
       if (isMissingValue(c.sender_email || c.email_glaeubiger)) reasons.push('missing email');
       if (isMissingValue(c.sender_address || c.glaeubiger_adresse)) reasons.push('missing address');
       if (isMissingValue(c.sender_name || c.glaeubiger_name)) reasons.push('missing name');
       console.log(`      - ${c.sender_name || c.glaeubiger_name || 'Unknown'}: ${reasons.join(', ')}`);
   });
   console.log(`   Creditors OK: ${confidenceOk.length}`);
   ```

3. **Update auto-approval status history metadata** (line 585) to reflect the new logic:
   - Change reason from "Auto-approved: No documents require manual review" to "Auto-approved: All creditors pass review flag and contact checks"
  </action>
  <verify>
1. Read the modified code and confirm:
   - `requiresManualReview` boolean is computed from `needsReview.length > 0 || creditors.length === 0`
   - All branching logic uses `requiresManualReview` / `!requiresManualReview` consistently
   - Empty creditor list routes to `creditor_review`
   - Console.log messages reference review flags and contact checks (not document flags)
   - Auto-approval history entry says "All creditors pass review flag and contact checks"
2. Run: `node -e "require('./server/controllers/zendeskWebhookController')"` from project root to verify no syntax errors
  </verify>
  <done>
Empty creditor list routes to creditor_review. All branching uses single requiresManualReview boolean. Logging reflects actual review reasons (needs_manual_review flag + contact fields). Auto-approval message updated.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete, verify the entire payment handler logic:

1. **Syntax check**: `node -e "require('./server/controllers/zendeskWebhookController')"`
2. **Code review**: Read handleUserPaymentConfirmed() and confirm:
   - `creditor.needs_manual_review === true` is checked FIRST in helper
   - Name field is checked alongside email and address
   - Field names match schema: `sender_email`, `email_glaeubiger`, `sender_address`, `glaeubiger_adresse`, `sender_name`, `glaeubiger_name`
   - No document flag traversal code remains in the helper
   - Empty creditor list routes to `creditor_review`
   - `requiresManualReview` boolean gates ALL status branching
   - Console logging shows actual review reasons
3. **Phase success criteria check**:
   - PAY-01: Payment handler checks `creditor.needs_manual_review` flag -- YES, first check in helper
   - PAY-02: Any creditor with needs_manual_review=true routes to creditor_review -- YES, helper returns true, gates status
   - PAY-03: Auto-approval requires ALL creditors pass ALL checks -- YES, needs_manual_review + email + address + name
</verification>

<success_criteria>
1. `creditorNeedsManualReview()` checks `needs_manual_review` flag before contact fields
2. Name field validation added (was missing) using `sender_name || glaeubiger_name`
3. Empty creditor list routes to `creditor_review`
4. All status branching uses single `requiresManualReview` boolean
5. No syntax errors in modified file
6. Console output accurately describes review reasons
</success_criteria>

<output>
After completion, create `.planning/phases/02-payment-status-logic/02-01-SUMMARY.md`
</output>
