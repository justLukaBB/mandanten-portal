---
phase: 07-aktenzeichen-na-suppression
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [server/services/firstRoundDocumentGenerator.js]
autonomous: true

must_haves:
  truths:
    - "When a creditor has no Aktenzeichen (null, undefined, empty, or 'N/A'), the generated first Anschreiben Word document shows an empty/blank field"
    - "When a creditor HAS a valid Aktenzeichen, it displays normally in the generated document"
    - "Other fields in the template (Creditor name, address, claim amount, dates) remain unaffected"
  artifacts:
    - path: "server/services/firstRoundDocumentGenerator.js"
      provides: "Aktenzeichen N/A suppression in prepareTemplateData()"
      contains: "isUsableValue"
  key_links:
    - from: "server/services/firstRoundDocumentGenerator.js:prepareTemplateData()"
      to: "isUsableValue helper (line 7-8)"
      via: "filtering reference_number candidates through isUsableValue before returning"
      pattern: "isUsableValue.*reference"
---

<objective>
Suppress "N/A" and "Nicht verfügbar" display for missing Aktenzeichen in the first Anschreiben Word template.

Purpose: When a creditor's reference number is missing or "N/A", the generated Word document currently shows "Nicht verfügbar". Users want an empty/blank field instead.
Output: Modified `prepareTemplateData()` method that returns empty string for missing/N/A Aktenzeichen.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-aktenzeichen-na-suppression/07-RESEARCH.md
@server/services/firstRoundDocumentGenerator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply isUsableValue filter to Aktenzeichen fallback chain</name>
  <files>server/services/firstRoundDocumentGenerator.js</files>
  <action>
In `prepareTemplateData()` method (starts at line 1313), modify the "Aktenzeichen D C" field (lines 1335-1340).

Current code (lines 1335-1340):
```javascript
"Aktenzeichen D C":
  creditor.reference_number ||
  creditor.creditor_reference ||
  creditor.reference ||
  creditor.aktenzeichen ||
  "Nicht verfügbar",
```

Replace with:
```javascript
"Aktenzeichen D C":
  [
    creditor.reference_number,
    creditor.creditor_reference,
    creditor.reference,
    creditor.aktenzeichen
  ].find(ref => isUsableValue(ref)) || "",
```

This uses the existing `isUsableValue` helper (line 7-8) which already filters out empty strings, whitespace-only strings, and "N/A" (case-insensitive). The final fallback is `""` (empty string) instead of `"Nicht verfügbar"`.

DO NOT modify any other fields in `prepareTemplateData()`. The `isUsableValue` helper is already used for the `Creditor` field (lines 1331-1333) and `"Adresse D C"` field (line 1328), so this follows the established pattern.

DO NOT modify the template file (`server/templates/1.Schreiben.docx`) or any other generator files.
  </action>
  <verify>
1. Read the modified file and confirm lines around 1335 now use `isUsableValue` and `|| ""`
2. Run `node -e "const g = require('./server/services/firstRoundDocumentGenerator'); console.log('Module loads OK')"` from project root to confirm no syntax errors
3. Grep for "Nicht verfügbar" in the file -- it should NOT appear in the Aktenzeichen field (may still exist elsewhere in file if used for other fields; verify it is gone from the Aktenzeichen context only)
  </verify>
  <done>
- "Aktenzeichen D C" field uses `.find(ref => isUsableValue(ref)) || ""` pattern
- No "Nicht verfügbar" fallback for the Aktenzeichen field
- All other fields in prepareTemplateData() unchanged
- File loads without syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify fix handles all edge cases</name>
  <files>server/services/firstRoundDocumentGenerator.js</files>
  <action>
Write and run an inline Node.js verification script (do NOT create a permanent test file) that exercises the fix against all edge cases. Run it from the project root directory.

The script should:
1. Require FirstRoundDocumentGenerator
2. Create a generator instance
3. Create minimal clientData and creditor objects
4. Call prepareTemplateData() with various creditor scenarios
5. Assert the "Aktenzeichen D C" field value for each

Test cases:
- `reference_number: "N/A"` (all other ref fields null) -> expect `""`
- `reference_number: "n/a"` (lowercase) -> expect `""`
- `reference_number: null` (all ref fields null) -> expect `""`
- `reference_number: undefined` (all ref fields undefined) -> expect `""`
- `reference_number: ""` (empty string) -> expect `""`
- `reference_number: "  "` (whitespace only) -> expect `""`
- `reference_number: "AZ-2024-001"` (valid) -> expect `"AZ-2024-001"`
- `reference_number: "N/A", creditor_reference: "REF-123"` (first is N/A, second is valid) -> expect `"REF-123"`
- `reference_number: "N/A", creditor_reference: "N/A", reference: "N/A", aktenzeichen: "AZ-999"` (only last is valid) -> expect `"AZ-999"`

Run the script with `node -e "..."` or `node -p "..."`. Print PASS/FAIL for each case. If any FAIL, the task is not done.

Important: `prepareTemplateData` requires `clientData` with at minimum `name`, `address`, `geburtsdatum` fields, and `creditor` with `sender_name`, `claim_amount`. Read the method signature if unsure about required fields -- but keep test data minimal. If the method accesses fields that are undefined, wrap with try-catch and diagnose.
  </action>
  <verify>
All 9 test cases print PASS. Zero FAIL results.
  </verify>
  <done>
- All edge cases verified: N/A (any case), null, undefined, empty, whitespace -> empty string
- Valid reference numbers pass through unchanged
- Fallback chain still works (first valid wins among multiple candidate fields)
  </done>
</task>

</tasks>

<verification>
1. `grep -n "Nicht verfügbar" server/services/firstRoundDocumentGenerator.js` -- should NOT match in the Aktenzeichen context
2. `grep -n "isUsableValue" server/services/firstRoundDocumentGenerator.js` -- should show usage in the Aktenzeichen field (around line 1335)
3. Module loads without errors: `node -e "require('./server/services/firstRoundDocumentGenerator')"`
4. All 9 edge case test assertions pass
</verification>

<success_criteria>
- The "Aktenzeichen D C" template field returns "" (empty string) when all reference number candidates are missing, empty, or "N/A"
- Valid reference numbers still display correctly
- No other template fields are affected
- No syntax errors introduced
- Follows the existing isUsableValue pattern already used elsewhere in the same method
</success_criteria>

<output>
After completion, create `.planning/phases/07-aktenzeichen-na-suppression/07-01-SUMMARY.md`
</output>
