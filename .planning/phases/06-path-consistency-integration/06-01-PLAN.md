---
phase: 06-path-consistency-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/aiDedupScheduler.js
  - server/controllers/adminClientCreditorController.js
autonomous: true

must_haves:
  truths:
    - "Admin manual trigger and auto pipeline call the same runAIRededup function"
    - "Admin gets atomic guard (dedup_in_progress) preventing double-click race conditions"
    - "Admin returns HTTP 409 Conflict when dedup is already running"
    - "Admin HTTP response preserves existing schema: { success, message, stats, creditors }"
    - "Both paths use 60s timeout, 2-attempt retry, and manual review flagging on failure"
    - "Dedup history entries include source field distinguishing 'auto' vs 'admin'"
  artifacts:
    - path: "server/services/aiDedupScheduler.js"
      provides: "Shared dedup service with options parameter (source, timeout)"
      contains: "options = {}"
    - path: "server/controllers/adminClientCreditorController.js"
      provides: "Thin admin controller calling runAIRededup service"
      contains: "runAIRededup"
  key_links:
    - from: "server/controllers/adminClientCreditorController.js"
      to: "server/services/aiDedupScheduler.js"
      via: "require('../services/aiDedupScheduler')"
      pattern: "runAIRededup\\("
    - from: "server/controllers/adminClientCreditorController.js"
      to: "HTTP 409 response"
      via: "Guard result check"
      pattern: "res\\.status\\(409\\)"
    - from: "server/services/aiDedupScheduler.js"
      to: "deduplication_history"
      via: "source field in history entry"
      pattern: "source:"
---

<objective>
Unify auto pipeline and admin manual trigger to use the same runAIRededup service function. Replace ~230 lines of duplicated dedup logic in the admin controller with a thin HTTP wrapper that calls the shared service layer, handles 409 Conflict for concurrent operations, and preserves the existing admin API response schema.

Purpose: Eliminates code divergence between two dedup paths. Admin gains retry (2 attempts, 2s delay), atomic guard, 60s timeout, and consistent enrichment/field-preservation logic that auto pipeline already has. No more silent failures or missing concurrency protection in admin path.

Output: Modified aiDedupScheduler.js (options parameter added) and refactored adminClientCreditorController.js (triggerAIReDedup calls service layer)
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-path-consistency-integration/06-CONTEXT.md
@.planning/phases/06-path-consistency-integration/06-RESEARCH.md
@server/services/aiDedupScheduler.js
@server/controllers/adminClientCreditorController.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add options parameter to runAIRededup and add source to dedup history</name>
  <files>server/services/aiDedupScheduler.js</files>
  <action>
  Modify `runAIRededup` function signature from `(clientId, getClientFunction)` to `(clientId, getClientFunction, options = {})`.

  Destructure options at top of function body:
  ```javascript
  const { source = 'auto' } = options;
  ```

  In the dedup history push (around line 347), add `source` field:
  ```javascript
  client.deduplication_history.push({
    timestamp: new Date(),
    method: 'immediate-ai-rededup',
    source: source,
    before_count: beforeCount,
    after_count: deduplicated_creditors.length,
    duplicates_removed: stats.duplicates_removed,
    processing_time_ms: Date.now() - startTime
  });
  ```

  IMPORTANT: Do NOT change anything else in the function. The existing retry logic, enrichment, field preservation, atomic guard, timeout, and error handling are all correct and must remain unchanged. The `scheduleAIRededup` call on line 109 passes only 2 args -- this is fine because `options` defaults to `{}`.

  Verify `module.exports` still exports `runAIRededup` (it already does on line 454).
  </action>
  <verify>
  1. Read the modified file and confirm:
     - Function signature is `async function runAIRededup(clientId, getClientFunction, options = {})`
     - `const { source = 'auto' } = options;` exists near top of function
     - History push includes `source: source`
  2. Grep for `runAIRededup` in the file to confirm no other call sites broke
  3. Run `node -e "const m = require('./server/services/aiDedupScheduler'); console.log(typeof m.runAIRededup)"` to verify module still exports correctly (should print "function")
  </verify>
  <done>runAIRededup accepts optional third parameter with source field. Existing callers (scheduleAIRededup) unaffected due to default value. History entries now include source field.</done>
</task>

<task type="auto">
  <name>Task 2: Replace admin triggerAIReDedup with service layer call</name>
  <files>server/controllers/adminClientCreditorController.js</files>
  <action>
  Replace the entire `triggerAIReDedup` method body (lines 607-838) with a thin controller that calls the shared service layer. The admin controller must:

  1. **Add import** at top of the controller factory function (inside `createAdminClientCreditorController`), or at module level:
     ```javascript
     const { runAIRededup } = require('../services/aiDedupScheduler');
     ```

  2. **Keep the client lookup** (lines 613-636) -- this is HTTP-specific validation. Keep the `$or` lookup with id/aktenzeichen and the ObjectId fallback. Keep the 404 response.

  3. **Keep the empty creditor check** (lines 638-644) -- return 400 if no creditors.

  4. **Replace everything from line 646 to 838** with:
     ```javascript
     // Call shared service layer
     const result = await runAIRededup(client._id, (id) => Client.findById(id), {
       source: 'admin'
     });

     // Handle concurrent operation (atomic guard failed)
     if (!result) {
       // runAIRededup returns undefined for edge cases (no creditors, client not found)
       return res.status(500).json({
         error: 'Deduplication returned no result',
         details: 'Unexpected state - check server logs'
       });
     }

     if (!result.success && result.reason === 'dedup_already_in_progress') {
       return res.status(409).json({
         error: 'Deduplication already in progress',
         message: 'Another dedup operation is currently running for this client. Please wait and try again.',
         retry_after: 60
       });
     }

     // Handle failure (retry exhausted, manual review flagged)
     if (!result.success) {
       return res.status(500).json({
         error: 'Failed to trigger AI re-deduplication',
         details: result.error || result.failure_reason || 'Unknown error',
         manual_review_flagged: result.manual_review_flagged || false
       });
     }

     // Success: reload client for updated creditor list (frontend needs full array)
     const updatedClient = await Client.findById(client._id);

     res.json({
       success: true,
       message: 'AI re-deduplication completed successfully',
       stats: {
         original_count: result.before_count,
         unique_count: result.after_count,
         duplicates_removed: result.duplicates_removed
       },
       creditors: updatedClient.final_creditor_list
     });
     ```

  5. **Keep the outer try/catch** (line 608 and 821-838) but simplify the error handler since service layer handles most errors:
     ```javascript
     } catch (error) {
       console.error('[admin-rededup] Error triggering AI re-dedup:', error.message);
       res.status(500).json({
         error: 'Failed to trigger AI re-deduplication',
         details: error.message
       });
     }
     ```

  IMPORTANT things to preserve in the response schema:
  - `success: true` (boolean)
  - `message: 'AI re-deduplication completed successfully'` (string)
  - `stats: { original_count, unique_count, duplicates_removed }` (object)
  - `creditors: [...]` (full array for frontend refresh)

  IMPORTANT things that are NOW handled by the service layer (DELETE from controller):
  - axios import and FastAPI call (service handles this with retry)
  - enrichDedupedCreditorFromDb / enrichment loop (service handles this)
  - isMissing helper and manual review check (service handles this)
  - existingMap build and field preservation map (service handles this)
  - dedup history push (service handles this with source field)
  - The `enrichDedupedCreditorFromDb` function at the top of the file (lines 8-80) can remain since other endpoints may use it. Do NOT delete it.

  ALSO REMOVE from admin controller:
  - The `status_history.push` block (lines 794-804) that wrote to `status_history` -- the service layer now writes to `deduplication_history` with source='admin', which is the correct unified approach per CONTEXT.md. The status_history was an admin-specific divergence that this phase eliminates.

  The `require('axios')` inline on line 649 can be removed since the admin controller no longer calls FastAPI directly.
  </action>
  <verify>
  1. Read the modified file and confirm:
     - `runAIRededup` is imported from '../services/aiDedupScheduler'
     - `triggerAIReDedup` method calls `runAIRededup(client._id, ..., { source: 'admin' })`
     - HTTP 409 response exists for `dedup_already_in_progress`
     - Success response has `{ success, message, stats, creditors }` shape
     - No axios import or FastAPI URL inside triggerAIReDedup
     - No enrichment logic inside triggerAIReDedup
     - No status_history push inside triggerAIReDedup
  2. Grep for `300000` (old 300s timeout) in the file -- should NOT appear in triggerAIReDedup
  3. Grep for `deduplicate-all` in the file -- should NOT appear in triggerAIReDedup (service handles this)
  4. Run `node -e "require('./server/controllers/adminClientCreditorController')"` to verify module loads without syntax errors
  </verify>
  <done>Admin triggerAIReDedup is a thin HTTP controller (~40 lines) that delegates to runAIRededup. No more duplicated dedup logic. Admin gets retry, atomic guard, 60s timeout, and consistent enrichment for free. Response schema preserved for frontend compatibility. HTTP 409 returned for concurrent operations.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase requirements:

**PATH-01: Auto pipeline and admin manual trigger use the same dedup function**
- Grep `runAIRededup` in both files -- both must call the same function
- Auto: `scheduleAIRededup` -> `runAIRededup` (line 109)
- Admin: `triggerAIReDedup` -> `runAIRededup` (new code)

**PATH-02: Response schema to Node.js backend remains unchanged**
- Admin response: `{ success: true, message: string, stats: { original_count, unique_count, duplicates_removed }, creditors: [...] }`
- This matches the existing schema at line 810-818

**Additional checks:**
- No `300000` (old 300s timeout) anywhere in admin controller's triggerAIReDedup
- No duplicate enrichment logic in admin controller's triggerAIReDedup
- `source: 'admin'` passed to runAIRededup from admin controller
- `source: 'auto'` is the default in runAIRededup (auto pipeline gets this automatically)
</verification>

<success_criteria>
1. Both auto pipeline and admin manual trigger call `runAIRededup` from `aiDedupScheduler.js`
2. Admin response schema unchanged: `{ success, message, stats, creditors }` with full creditor array
3. Admin gets atomic guard (409 Conflict on double-click), retry (2 attempts, 2s delay), and 60s timeout
4. Dedup history entries include `source: 'auto'` or `source: 'admin'`
5. ~190 lines of duplicated logic removed from admin controller
6. No syntax errors in either modified file
</success_criteria>

<output>
After completion, create `.planning/phases/06-path-consistency-integration/06-01-SUMMARY.md`
</output>
