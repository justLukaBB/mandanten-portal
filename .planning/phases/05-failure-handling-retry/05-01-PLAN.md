---
phase: 05-failure-handling-retry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/models/Client.js
  - server/services/aiDedupScheduler.js
autonomous: true

must_haves:
  truths:
    - "Dedup retries once on LLM failure before falling back (FAIL-01)"
    - "Each attempt is logged with creditor count, error message, and attempt number (FAIL-03)"
    - "Timeout on FastAPI call is 60 seconds, not 5 minutes"
  artifacts:
    - path: "server/models/Client.js"
      provides: "dedup_failure_reason field on clientSchema"
      contains: "dedup_failure_reason"
    - path: "server/services/aiDedupScheduler.js"
      provides: "Retry wrapper function and reduced timeout"
      contains: "retryWithDelay"
  key_links:
    - from: "server/services/aiDedupScheduler.js"
      to: "server/models/Client.js"
      via: "dedup_failure_reason field used in failure handler"
      pattern: "dedup_failure_reason"
---

<objective>
Add retry infrastructure to the AI dedup scheduler: a reusable retry wrapper function, reduced timeout (60s), and the schema field for storing failure reasons.

Purpose: Foundation for FAIL-01 (retry once) and FAIL-03 (structured logging). The retry wrapper and schema field are prerequisites for Plan 02's manual review flagging integration.

Output: `retryWithDelay()` helper in aiDedupScheduler.js, `dedup_failure_reason` field in Client schema, timeout reduced from 300000ms to 60000ms.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-failure-handling-retry/05-CONTEXT.md
@.planning/phases/05-failure-handling-retry/05-RESEARCH.md
@server/services/aiDedupScheduler.js
@server/models/Client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dedup_failure_reason field to Client schema</name>
  <files>server/models/Client.js</files>
  <action>
Add a `dedup_failure_reason` field to the `clientSchema` in server/models/Client.js. Place it next to the existing dedup coordination fields (`dedup_in_progress`, `dedup_started_at`, `dedup_completed_at`) around line 315-318.

Add this field:
```javascript
dedup_failure_reason: String, // Reason for dedup failure (e.g., "AI deduplication failed after 2 attempts: timeout")
```

This mirrors the `status_reason` pattern from documentSchema (line 29). The field stores a human-readable failure reason when dedup fails after retry, so admins know WHY manual review is needed.

Do NOT add a case-level `needs_manual_review` boolean — the existing `current_status` field already handles routing to `creditor_review` when review is needed. The `dedup_failure_reason` is the new field.
  </action>
  <verify>
Run: `grep -n "dedup_failure_reason" server/models/Client.js` — should show the new field.
Run: `node -e "require('./server/models/Client')"` from the project root — should load without errors.
  </verify>
  <done>Client schema has `dedup_failure_reason: String` field next to dedup coordination fields. Model loads without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add retry wrapper and reduce timeout in aiDedupScheduler</name>
  <files>server/services/aiDedupScheduler.js</files>
  <action>
Make two changes to server/services/aiDedupScheduler.js:

**Change 1: Reduce timeout from 300000ms to 60000ms**

On line 123, change `timeout: 300000` to `timeout: 60000`. This catches Vertex AI hangs per the context decision (60-second timeout).

**Change 2: Add retryWithDelay() helper function**

Add a `retryWithDelay` function AFTER the `mergeReviewReasons` function (around line 28) and BEFORE the `pendingJobs` declaration. This keeps helpers grouped together.

```javascript
/**
 * Retry an async function with delay between attempts.
 * Logs each attempt per FAIL-03 requirement.
 *
 * @param {Function} fn - Async function to retry. Receives (attemptNumber) as argument.
 * @param {Object} options - { maxAttempts: 2, delayMs: 2000 }
 * @returns {Promise<*>} Result of fn on success
 * @throws Last error if all attempts fail
 */
async function retryWithDelay(fn, options = {}) {
  const maxAttempts = options.maxAttempts || 2;
  const delayMs = options.delayMs || 2000;
  let lastError;

  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await fn(attempt);
    } catch (error) {
      lastError = error;

      console.error(`[ai-dedup-scheduler] Attempt ${attempt}/${maxAttempts} failed:`, {
        error_message: error.message,
        attempt_number: attempt,
        max_attempts: maxAttempts,
        status: error.response?.status || 'no_response',
        will_retry: attempt < maxAttempts
      });

      if (attempt < maxAttempts) {
        console.log(`[ai-dedup-scheduler] Retrying in ${delayMs}ms...`);
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
    }
  }

  throw lastError;
}
```

Key design choices:
- Logs EVERY attempt with attempt number, creditor count context comes from caller (FAIL-03)
- `will_retry` field tells operators whether another attempt is coming
- Uses native Promise delay — no external dependencies (per research recommendation)
- Returns last error so caller can include it in manual review reason
- Does NOT distinguish retryable vs non-retryable errors — context decision says "retry all error types equally"
  </action>
  <verify>
Run: `grep -n "retryWithDelay" server/services/aiDedupScheduler.js` — should show the function definition.
Run: `grep -n "timeout: 60000" server/services/aiDedupScheduler.js` — should show the reduced timeout.
Run: `node -e "require('./server/services/aiDedupScheduler')"` from project root — should load without errors.
  </verify>
  <done>
`retryWithDelay()` function exists in aiDedupScheduler.js with per-attempt logging. Timeout is 60000ms (60 seconds). Module loads without errors.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "dedup_failure_reason" server/models/Client.js` shows field definition
2. `grep -n "retryWithDelay" server/services/aiDedupScheduler.js` shows function
3. `grep -n "timeout: 60000" server/services/aiDedupScheduler.js` shows reduced timeout
4. `grep -c "timeout: 300000" server/services/aiDedupScheduler.js` returns 0 (old timeout gone)
5. `node -e "require('./server/models/Client'); require('./server/services/aiDedupScheduler'); console.log('OK')"` prints OK
</verification>

<success_criteria>
- Client schema has dedup_failure_reason field
- retryWithDelay() helper exists with per-attempt structured logging
- Timeout reduced from 300000ms to 60000ms
- Both modules load without errors
- No new dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/05-failure-handling-retry/05-01-SUMMARY.md`
</output>
