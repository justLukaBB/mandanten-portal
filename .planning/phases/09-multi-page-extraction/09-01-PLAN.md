---
phase: 09-multi-page-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /tmp/creditor-fastapi/app/models.py
  - /tmp/creditor-fastapi/app/services/document_processor.py
autonomous: true

must_haves:
  truths:
    - "Extraction prompt includes PDF-specific page assignment instructions when processing PDFs"
    - "Extraction prompt is unchanged when processing single images"
    - "CreditorData model has a pages field (List[int]) for page assignments"
    - "Gemini response page data is parsed and normalized (handles arrays, ints, range strings)"
    - "Page numbers are validated against actual page_count (1-based, in range)"
  artifacts:
    - path: "/tmp/creditor-fastapi/app/models.py"
      provides: "CreditorData with pages field"
      contains: "pages"
    - path: "/tmp/creditor-fastapi/app/services/document_processor.py"
      provides: "PDF-specific extraction prompt extension and page data parsing"
      contains: "Seiten"
  key_links:
    - from: "/tmp/creditor-fastapi/app/services/document_processor.py"
      to: "/tmp/creditor-fastapi/app/models.py"
      via: "CreditorData pages field assignment"
      pattern: "pages="
    - from: "/tmp/creditor-fastapi/app/services/document_processor.py"
      to: "Gemini extraction prompt"
      via: "conditional PDF instruction injection"
      pattern: "is_pdf.*page_count"
---

<objective>
Add PDF-specific page assignment to the extraction prompt and CreditorData model. When processing a PDF, the extraction prompt gets additional German-language instructions telling Gemini to include a "Seiten" (pages) array for each creditor. The page data is parsed, normalized (handling arrays, ints, string ranges), and validated against actual page count. Image extraction remains completely unchanged.

Purpose: This is the core extraction capability for Phase 9 -- without page assignment data, the system cannot tell which PDF pages belong to which creditor.
Output: Modified CreditorData model with `pages` field, modified `extract_data()` with conditional PDF prompt extension and page data parsing.
</objective>

<execution_context>
@/Users/luka.s/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luka.s/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-multi-page-extraction/09-RESEARCH.md
@.planning/phases/09-multi-page-extraction/09-CONTEXT.md
@.planning/phases/08-fastapi-pdf-support/08-01-SUMMARY.md

Key source files (in separate FastAPI repository at /tmp/creditor-fastapi):
@/tmp/creditor-fastapi/app/models.py
@/tmp/creditor-fastapi/app/services/document_processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pages field to CreditorData and extend extraction prompt for PDFs</name>
  <files>
    /tmp/creditor-fastapi/app/models.py
    /tmp/creditor-fastapi/app/services/document_processor.py
  </files>
  <action>
**Step A: Extend CreditorData model in models.py**

Add a `pages` field to the `CreditorData` class:
```python
# Page assignment (PDF multi-page extraction)
pages: List[int] = Field(default_factory=list, description="1-based page numbers where this creditor's info appears in the PDF")
```
Place it after the `glaeubiger_vertreter_email` field (end of the class). The `List` import already exists in the file.

**Step B: Add PDF extraction instructions method to DocumentProcessor in document_processor.py**

Add a new method `_get_pdf_extraction_instructions(self, page_count: int) -> str` to the `DocumentProcessor` class. Place it after the `_validate_pdf()` method. This method returns a German-language prompt extension:

```python
def _get_pdf_extraction_instructions(self, page_count: int) -> str:
    """
    Get PDF-specific extraction instructions for page assignment.

    Args:
        page_count: Number of pages in the PDF

    Returns:
        German-language prompt extension for page assignment
    """
    return f"""

**MEHRSEITIGE PDF-DOKUMENTE:**
Dieses Dokument ist ein PDF mit {page_count} Seiten.

Fuer JEDEN erkannten Glaebiger gib zusaetzlich an, auf welchen Seiten dessen Informationen zu finden sind:
- "Seiten": [1, 2, 3] -- Liste der Seitennummern (1-basiert, erste Seite = 1)

Beachte:
- Ein Glaeubiger-Brief kann sich ueber MEHRERE Seiten erstrecken (z.B. eine 3-seitige Forderungsaufstellung ist EIN Glaebiger, nicht drei)
- Mehrere Glaeubigerbuefe koennen in einem Sammel-Scan zusammengefasst sein
- Seiten die zu keinem Glaebiger gehoeren (Deckblaetter, leere Seiten, Trennblaetter) einfach weglassen
- Wenn du dir bei einer Seite unsicher bist, ordne sie NICHT zu
- "Seiten" MUSS immer eine Liste sein, auch bei nur einer Seite: [3] (nicht 3)

Beispiel fuer einen {page_count}-seitigen PDF mit mehreren Glaeubigern:
"creditors": [
  {{"Glaebiger_Name": "Bank A", "Seiten": [1, 2], ...}},
  {{"Glaebiger_Name": "Inkasso B", "Seiten": [3], ...}},
  {{"Glaebiger_Name": "Versicherung C", "Seiten": [5, 6, 7], ...}}
]
(Seiten 4 und 8 gehoeren zu keinem Glaebiger -- einfach weglassen)
"""
```

Note: Use ASCII-safe characters in the f-string (ae, oe, ue instead of umlauts) to avoid encoding issues. The prompt examples use double braces `{{` `}}` for f-string escaping.

**Step C: Modify extract_data() to conditionally inject PDF instructions**

In the `extract_data()` method:

1. Add `page_count: int = None` as an optional parameter to the method signature:
   ```python
   def extract_data(self, image_path: str, page_count: int = None) -> ExtractedData:
   ```

2. After the prompt string (around line 519, after the closing `"""`), add conditional PDF instruction injection:
   ```python
   # Add PDF-specific page assignment instructions
   is_pdf = os.path.splitext(image_path)[1].lower() == '.pdf'
   if is_pdf and page_count:
       prompt += self._get_pdf_extraction_instructions(page_count)
   ```

3. In the creditor parsing loop (around line 550-610, inside `for cred in creditors_list:`), after extracting `email_vertreter`, add page data parsing and normalization:
   ```python
   # Parse and normalize page data (PDF only)
   raw_pages = cred.get("Seiten", [])
   pages = []
   if isinstance(raw_pages, list):
       for p in raw_pages:
           if isinstance(p, (int, float)) and 1 <= int(p) <= (page_count or float('inf')):
               pages.append(int(p))
   elif isinstance(raw_pages, int):
       if 1 <= raw_pages <= (page_count or float('inf')):
           pages = [raw_pages]
   elif isinstance(raw_pages, str):
       # Handle range strings like "1-3"
       try:
           parts = raw_pages.split("-")
           if len(parts) == 2:
               start, end = int(parts[0].strip()), int(parts[1].strip())
               pages = [p for p in range(start, end + 1) if 1 <= p <= (page_count or float('inf'))]
       except (ValueError, IndexError):
           pass

   if raw_pages and not pages:
       logger.warning(f"Invalid page data from Gemini: {raw_pages} (page_count={page_count})")
   ```

4. Add the `pages` field to the `CreditorData(...)` constructor call (around line 591-609):
   ```python
   creditor_data = CreditorData(
       # ... existing fields ...
       pages=pages,  # Add this after glaeubiger_vertreter_email
   )
   ```

**IMPORTANT: Do NOT modify the existing prompt text for images.** The PDF instructions are appended only when `is_pdf and page_count` is true. The base prompt remains identical for image processing.
  </action>
  <verify>
1. Run `cd /tmp/creditor-fastapi && python -c "from app.models import CreditorData; c = CreditorData(); print('pages:', c.pages); c2 = CreditorData(pages=[1,2,3]); print('pages set:', c2.pages)"` -- should print `pages: []` then `pages set: [1, 2, 3]`
2. Run `cd /tmp/creditor-fastapi && python -c "from app.services.document_processor import DocumentProcessor; print('import OK')"` -- should succeed without errors
3. Run `cd /tmp/creditor-fastapi && python -c "
from app.models import CreditorData
# Verify pages field exists and defaults to empty list
c = CreditorData()
assert c.pages == [], f'Expected empty list, got {c.pages}'
# Verify pages accepts list of ints
c2 = CreditorData(pages=[1, 3, 5])
assert c2.pages == [1, 3, 5], f'Expected [1,3,5], got {c2.pages}'
print('All model assertions passed')
"` -- should print "All model assertions passed"
4. Verify the extraction prompt for images is unchanged by checking that `_get_pdf_extraction_instructions` is only called conditionally (grep for `is_pdf and page_count`)
  </verify>
  <done>
- CreditorData model has `pages: List[int]` field with empty list default
- extract_data() accepts optional `page_count` parameter
- PDF extraction prompt includes German-language page assignment instructions with examples
- Image extraction prompt is completely unchanged (no PDF text appended)
- Page data from Gemini response is parsed and normalized (handles list, int, and string range formats)
- Invalid page numbers (out of range, wrong type) are filtered with warning logs
  </done>
</task>

</tasks>

<verification>
1. CreditorData model imports and instantiates without errors
2. DocumentProcessor imports without errors
3. pages field defaults to empty list, accepts list of ints
4. No changes to the base extraction prompt (grep for the prompt text to verify unchanged)
5. _get_pdf_extraction_instructions method exists and returns string with "Seiten" and page_count
</verification>

<success_criteria>
- CreditorData.pages field exists as List[int] with empty default
- extract_data() has page_count parameter (optional, default None)
- PDF processing appends page assignment instructions to prompt
- Image processing prompt is byte-for-byte identical to before
- Page data parsing handles: list of ints, single int, string range, invalid values
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-page-extraction/09-01-SUMMARY.md`
</output>
